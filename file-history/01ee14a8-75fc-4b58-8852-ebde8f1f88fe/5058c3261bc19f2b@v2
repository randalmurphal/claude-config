"""Tests for Task dataclass."""

import pytest
from task_queue.task import Task, TaskPriority, TaskState


def test_task_creation():
    """Test basic task creation."""
    def sample_func(x: int) -> int:
        return x * 2

    task = Task(func=sample_func, args=(5,))

    assert task.func == sample_func
    assert task.args == (5,)
    assert task.kwargs == {}
    assert task.priority == TaskPriority.NORMAL
    assert task.state == TaskState.PENDING
    assert task.task_id != ""  # Should auto-generate


def test_task_execution():
    """Test task execution."""
    def add_numbers(a: int, b: int) -> int:
        return a + b

    task = Task(func=add_numbers, args=(3, 4))
    result = task.execute()

    assert result == 7
    assert task.state == TaskState.COMPLETED


def test_task_execution_failure():
    """Test task execution with failure."""
    def failing_func() -> None:
        raise ValueError("Test error")

    task = Task(func=failing_func)

    with pytest.raises(ValueError, match="Test error"):
        task.execute()

    assert task.state == TaskState.FAILED


def test_task_priority_comparison():
    """Test task priority ordering."""
    high_task = Task(func=lambda: None, priority=TaskPriority.HIGH)
    normal_task = Task(func=lambda: None, priority=TaskPriority.NORMAL)
    low_task = Task(func=lambda: None, priority=TaskPriority.LOW)

    assert high_task < normal_task
    assert normal_task < low_task
    assert high_task < low_task


def test_should_retry():
    """Test retry logic."""
    def failing_func() -> None:
        raise ValueError("Fail")

    task = Task(func=failing_func, max_retries=3)

    # Initially should not retry (not failed yet)
    assert not task.should_retry()

    # After failure, should retry
    try:
        task.execute()
    except ValueError:
        pass

    assert task.should_retry()
    assert task.retry_count == 0

    # After max retries, should not retry
    task.retry_count = 3
    assert not task.should_retry()