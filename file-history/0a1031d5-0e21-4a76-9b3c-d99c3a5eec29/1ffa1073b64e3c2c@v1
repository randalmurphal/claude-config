# PRISM MCP - Agent Handoff Document

## Date: 2025-09-29
## Current Status: 70% Functional - Critical Issues Block Core Functionality

---

## Quick Context

You're taking over PRISM MCP, an AI memory system with intelligent retrieval, pattern detection, and preference learning. The user wants the system "working as intended fully, not just returning successful responses but actually performing its designed functions."

The system has 6 critical unresolved issues that prevent it from functioning properly. This document provides everything you need to continue the work.

---

## What Works ✅

1. **E5-Mistral Model Loading** - Fixed device placement issue, loads successfully with 8-bit quantization
2. **Similarity Score Propagation** - Fixed tuple unpacking in orchestrator.py
3. **Pattern Downloads** - 155,260 patterns downloaded successfully
4. **Database Connections** - Qdrant, Neo4j, Redis all connect properly
5. **6-Stage Retrieval Pipeline Structure** - Architecture is sound

---

## Critical Issues to Fix ❌

### 1. StarCoder2 Device Placement (HIGHEST PRIORITY)
**File**: `prism_mcp/models/quantization.py` line 229
**Error**: `Expected all tensors on same device, got index on cpu, others on cuda:0`
**Impact**: Cannot generate code embeddings, blocks ALL pattern functionality
**Solution**: Apply same fix as E5-Mistral (lines 153-174) - don't move tensors to CUDA when using `device_map="auto"`

```python
# Current (broken) at line 229:
test_output = model(**test_input)  # test_input is on CPU but model expects CUDA

# Fix (like E5-Mistral):
# When using device_map="auto", keep test_input on CPU
# The model handles device placement internally
```

### 2. API Server Not Accessible
**Problem**: Process runs but port 8090 returns "Connection refused"
**Debugging Steps**:
```bash
# Check if port is bound
netstat -tulpn | grep 8090

# Check container logs
nerdctl logs prism-api

# Try direct native startup
cd ~/repos/claude_mcp/prism_mcp
python -m prism_mcp.interfaces.http_api --port 8090
```

### 3. Memory Embedding UUID Mismatch
**Error**: "No embedding found for memory_id=XXX"
**Location**: Throughout retrieval pipeline
**Issue**: Legacy 12-char hex vs modern 36-char UUID formats
**Check**: `_convert_memory_id_to_int()` function in memory_engine.py

### 4. Access Count Not Tracking
**Problem**: Neo4j not incrementing access_count, memories stuck in WORKING tier
**Check**:
- Neo4j update query in memory_engine.py
- Verify session_id is passed correctly
- Check transaction commits

### 5. Graph Expansion Disabled
**File**: `config/config.yaml`
**Fix**: Set `graph.expansion_enabled: true`

### 6. Health Status Reports "Unhealthy"
**Endpoint**: `/api/health/detailed`
**Likely Cause**: Model loading failures cascade to health check

---

## Fixes Already Applied

### orchestrator.py (lines 675-695)
```python
# Handle both tuple and direct Memory object returns
for item in final_results:
    if isinstance(item, tuple) and len(item) == 2:
        memory, scores = item
    else:
        memory = item
        scores = {}
```

### quantization.py (lines 153-174 for E5-Mistral only)
```python
# Skip dimension verification when using device_map
using_device_map = False
if device != "cpu":
    using_device_map = True

if not using_device_map:
    # Manual device placement
else:
    logger.info("Skipping dimension verification with device_map")
```

---

## Test Commands

```bash
# Quick functional test
python tests/test_functional.py

# Check pattern loading
curl http://localhost:6333/collections/code_patterns

# Test retrieval pipeline
python -c "
from prism_mcp.core.orchestrator import Orchestrator
orch = Orchestrator()
results = orch.retrieve('authentication best practices', session_id='test')
print(f'Found {len(results)} results')
"

# Check GPU usage
nvidia-smi

# API health check
curl -H "Authorization: Bearer prism_development_key_2024" \
     http://localhost:8090/api/health/detailed
```

---

## Key Files to Review

1. **prism_mcp/models/quantization.py** - StarCoder2 device fix needed
2. **prism_mcp/core/orchestrator.py** - Similarity score fix already applied
3. **prism_mcp/core/memory_engine.py** - UUID conversion and access count issues
4. **prism_mcp/interfaces/http_api.py** - API startup and binding issues
5. **config/config.yaml** - Enable graph expansion

---

## Background Context

### User Requirements
- "I dont want to make sure its just working, i want to prove its working as intended fully"
- "before we try to fix these issues... we need to understand it deeply"
- "get this fully functional with the bigger picture... not just returning successful but actually working as intended"

### Architecture Overview
- **6-Stage Retrieval Pipeline**: Semantic → Graph → Context → Temporal → Diversity → Scoring
- **4-Tier Memory System**: ANCHORS → LONGTERM → EPISODIC → WORKING
- **Dual-Model System**: E5-Mistral (4096 dims) + StarCoder2 (4608 dims) + BGE-Reranker
- **Pattern Database**: 155,260 patterns ready to load (90K Python, 64K Go, 1K JS)

---

## Recommended Next Steps

1. **Fix StarCoder2 device placement** - This unblocks pattern loading
2. **Debug API server binding** - Check why port 8090 isn't accessible
3. **Fix UUID conversion** - Resolve memory embedding mismatches
4. **Enable graph expansion** - Simple config change
5. **Fix access count tracking** - Debug Neo4j updates
6. **Load patterns** - Once StarCoder2 works, load all 155K patterns
7. **Run functional tests** - Validate everything works end-to-end

---

## Working Directory State

- Models downloaded: ✅ (in `~/.local/share/prism_mcp/models/`)
- Patterns downloaded: ✅ (in `~/.local/share/prism_mcp/processed_patterns/`)
- Databases running: ✅ (Neo4j, Qdrant, Redis containers)
- API process: ❌ (runs but port not accessible)
- Pattern loading: ❌ (blocked by StarCoder2)

---

## Important Notes

1. **NO DEFAULTS Philosophy**: System designed to crash loudly on missing requirements
2. **Device Placement Gotcha**: With `device_map="auto"`, NEVER manually move tensors
3. **UUID Systems**: Two incompatible formats in use - needs reconciliation
4. **API Workaround**: Currently using direct database loading instead of API

---

## Documentation Updated

- **IMPLEMENTATION_NOTES.md**: Added debugging session findings
- **This HANDOFF.md**: Created for smooth transition
- **CLAUDE.md**: Needs update with current system state

---

## Questions for User

Before proceeding, you might want to ask:
1. Should we prioritize getting patterns loaded or fixing the API first?
2. Is the 8090 port requirement strict or can we use another port?
3. Should we disable StarCoder2 temporarily to unblock pattern loading with E5 only?

---

*Handoff prepared by previous agent after comprehensive debugging session. Good luck! The architecture is sound - it just needs these specific fixes to work properly.*