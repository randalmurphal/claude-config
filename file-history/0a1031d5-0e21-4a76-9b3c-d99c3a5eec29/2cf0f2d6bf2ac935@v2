#!/usr/bin/env bash
# Test PRISM with correct endpoint names

API_URL="http://localhost:8090"
API_KEY="prism_development_key_2024"
PROJECT_PATH="/home/randy/repos/claude_mcp/prism_mcp"

echo "ðŸŽ¯ Testing PRISM (codebase-first approach)..."
echo

# 1. Store a learning (correction)
echo "1. Storing a correction about forex_trader architecture..."
curl -s -X POST "$API_URL/api/store_memory" \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "content": "In forex_trader project: Use clean architecture with domain/infrastructure separation. All business logic in domain layer, external services in infrastructure.",
    "memory_type": "correction",
    "tier": "ANCHORS",
    "context": {
      "project": "forex_trader",
      "language": "go",
      "role": "architect"
    },
    "frustration_score": 0.8
  }' | jq '.'
echo

# 2. Retrieve that memory
echo "2. Retrieving memories about architecture..."
curl -s -X POST "$API_URL/api/retrieve_memories" \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "query": "How should I structure code in forex trader?",
    "context": {
      "project": "forex_trader",
      "language": "go"
    },
    "limit": 3
  }' | jq '.results[] | {content, tier, memory_type, frustration_score}'
echo

# 3. Try indexing prism_mcp (Python code)
echo "3. Attempting to index prism_mcp codebase..."
echo "   (This may take 1-2 minutes for 118 files)"
curl -s -X POST "$API_URL/api/index_project" \
  -H "Authorization: Bearer $API_KEY" \
  -H "Content-Type: application/json" \
  -d "{
    \"project_path\": \"$PROJECT_PATH\",
    \"project_id\": \"prism_mcp_test\"
  }" | jq '.'
echo

echo "âœ… Test complete!"