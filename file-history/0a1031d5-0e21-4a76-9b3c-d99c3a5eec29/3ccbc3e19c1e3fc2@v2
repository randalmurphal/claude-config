#!/usr/bin/env python3
"""
Test Tier 0 (PREMIUM_API) implementation

Validates that the unified embedder correctly:
1. Initializes in API mode with Voyage + Jina
2. Embeds code and semantic text
3. Performs reranking
4. Returns correct dimensions
"""

import os
import sys
from pathlib import Path

# Add parent to path
sys.path.insert(0, str(Path(__file__).parent.parent))

import numpy as np
from prism_mcp.models.unified_embedder import UnifiedEmbedder
from prism_mcp.models.tier_detector import SystemTier
from prism_mcp.utils.config import load_config

print("="*80)
print("TIER 0 (PREMIUM_API) IMPLEMENTATION TEST")
print("="*80)

# Check API keys
voyage_key = os.getenv("VOYAGE_API_KEY")
jina_key = os.getenv("JINA_API_KEY")

if not voyage_key:
    print("\n❌ VOYAGE_API_KEY not set")
    print("Set with: export VOYAGE_API_KEY='pa-xxx'")
    sys.exit(1)

print(f"\n✓ VOYAGE_API_KEY: {voyage_key[:10]}...")
print(f"✓ JINA_API_KEY: {jina_key[:10] if jina_key else 'Not set (reranking disabled)'}")

# Load configuration
print("\n1. Loading configuration...")
config_path = Path(__file__).parent.parent / "config" / "config.yaml"
load_config(config_path)
print("✓ Config loaded")

# Initialize unified embedder in API mode
print("\n2. Initializing Unified Embedder (PREMIUM_API mode)...")
try:
    embedder = UnifiedEmbedder(tier=SystemTier.PREMIUM_API)
    print(f"✓ Embedder initialized (mode: {embedder.mode})")
except Exception as e:
    print(f"❌ Failed to initialize embedder: {e}")
    import traceback
    traceback.print_exc()
    sys.exit(1)

# Check dimensions
dims = embedder.get_dimensions()
print(f"\n3. Embedding dimensions:")
print(f"   Code: {dims['code']}d")
print(f"   Semantic: {dims['semantic']}d")
print(f"   Mode: {dims['mode']}")
print(f"   Tier: {dims['tier']}")

# Test code embedding
print("\n4. Testing code embedding...")
test_code = "def authenticate(username, password): return validate_credentials(username, password)"
code_emb = embedder.embed_code(test_code)
print(f"✓ Code embedded: shape={code_emb.shape}, dtype={code_emb.dtype}")

# Test semantic embedding
print("\n5. Testing semantic embedding...")
test_text = "JWT authentication with refresh tokens for secure API access"
text_emb = embedder.embed_text(test_text)
print(f"✓ Text embedded: shape={text_emb.shape}, dtype={text_emb.dtype}")

# Test batch embedding
print("\n6. Testing batch embedding...")
batch_codes = [
    "async def connect_db(): return await pool.acquire()",
    "def handle_error(e): log.error(str(e))",
    "class UserAuth: pass",
]
batch_embs = embedder.embed_code_batch(batch_codes)
print(f"✓ Batch embedded: shape={batch_embs.shape}")

# Test reranking (if available)
print("\n7. Testing reranking...")
if embedder.supports_reranking():
    query = "database connection pooling"
    docs = [
        "How to create a connection pool in Python",
        "Best practices for API authentication",
        "Managing database connections efficiently",
        "JWT token refresh strategies",
        "Connection pooling with async/await",
    ]
    reranked = embedder.rerank(query, docs, top_n=3)
    print(f"✓ Reranked {len(docs)} documents:")
    for i, (idx, score) in enumerate(reranked, 1):
        print(f"   {i}. [{score:.3f}] {docs[idx][:60]}")
else:
    print("⚠️  Reranking not available (Jina not initialized)")

# Get usage stats
print("\n8. Usage statistics:")
stats = embedder.get_usage_stats()
if 'voyage' in stats:
    v = stats['voyage']
    print(f"   Voyage:")
    print(f"      Tokens used: {v['total_tokens']:,}")
    print(f"      Requests: {v['total_requests']}")
    print(f"      Remaining free: {v['remaining_free_tokens']:,}")
if 'jina' in stats and stats['jina']:
    j = stats['jina']
    print(f"   Jina:")
    print(f"      Tokens used: {j.get('total_tokens', 0):,}")
    print(f"      Requests: {j.get('total_requests', 0)}")

print("\n" + "="*80)
print("✅ TIER 0 (PREMIUM_API) WORKING PERFECTLY!")
print("="*80)
print("\nNext steps:")
print("1. Update orchestrator/services to use UnifiedEmbedder")
print("2. Add tier selection logic (manual_tier: 0 in config)")
print("3. Test full retrieval pipeline with API embeddings")
print("4. Document API provider setup in README")