# PRISM Test Coverage Plan - Path to 90%+

## Current Status
- 250/302 tests passing (83% pass rate)
- 28% code coverage
- 0% coverage on critical interfaces (HTTP API, MCP server)

## Priority 1: Fix Failing Tests (Target: 100% pass rate)

### Integration Tests (12 failures)
- `test_preference_lifecycle.py` - 4 failures
- `test_preference_lifecycle_fixed.py` - 4 failures
- `test_preference_lifecycle_mocked.py` - 2 failures
- `test_rejection_learning_integration.py` - 2 failures

**Root Cause**: Likely database state/isolation issues

### Retrieval Coordinator (21 failures)
- Full pipeline tests
- Scoring tests
- Return scores tests
- Retrieval tracking
- Graph expansion

**Root Cause**: Mock setup or config issues

### Retrieval Modes (18 failures)
- Phase mapping
- Mode validation
- Lightning/Fast/Balanced modes
- Timeout enforcement
- Cache integration

**Root Cause**: Config or dependency injection

## Priority 2: Add Critical Interface Tests (0% → 80%)

### HTTP API (`http_api.py` - 783 lines, 0% coverage)
**New tests needed:**
1. Memory endpoints (store, retrieve, update, delete)
2. Preference endpoints (suggest, approve, reject, list)
3. Pattern detection endpoint
4. Health check endpoints
5. ADR endpoints (new feature)
6. Duplication detection (new feature)
7. Authentication/authorization
8. Error handling (400, 401, 500)

**Estimated**: 50-60 new test cases

### MCP Server (`mcp_server.py` - 104 lines, 0% coverage)
**New tests needed:**
1. Tool registration
2. Tool invocation
3. Error handling
4. Response formatting

**Estimated**: 15-20 new test cases

### Health Check (`health_check.py` - 265 lines, 0% coverage)
**New tests needed:**
1. Service connectivity checks
2. Detailed health reporting
3. Tier detection
4. Degradation scenarios

**Estimated**: 10-15 new test cases

## Priority 3: Increase Storage Coverage (32-50% → 80%)

### Qdrant Manager (32% → 80%)
- Collection management
- Point operations (upsert, retrieve, delete)
- Search operations
- Scroll operations
- Error handling

### Neo4j Manager (36% → 80%)
- Node/relationship CRUD
- Cypher query execution
- Transaction handling
- Error recovery

### Redis Cache (50% → 80%)
- Cache operations (get, set, delete)
- TTL management
- Eviction policies
- Pipeline operations

## Priority 4: Edge Cases & Error Paths (Current gaps)

### Error Messages (24% coverage)
- All error scenarios
- Helpful error messages
- Recovery suggestions

### Concept Extractor (27% coverage)
- Text analysis
- Concept extraction
- Edge cases (empty, malformed)

## Implementation Strategy

### Phase 1: Fix Failing Tests (Week 1)
**Goal**: 100% test pass rate
1. Run each failing test individually
2. Identify root cause (state, mocks, config)
3. Fix or mark as integration-only
4. Target: 302/302 passing

### Phase 2: HTTP API Tests (Week 2)
**Goal**: 80% API coverage
1. Create `tests/api/` directory
2. Test each endpoint with:
   - Happy path
   - Error cases (400, 401, 500)
   - Edge cases
3. Use mocked dependencies (fast tests)
4. Target: +50 tests, 80% API coverage

### Phase 3: Integration Tests (Week 3)
**Goal**: Full end-to-end validation
1. Fix database isolation issues
2. Add transaction rollback
3. Test full workflows
4. Target: All integration tests passing

### Phase 4: Storage & Utils (Week 4)
**Goal**: 80% overall coverage
1. Complete storage layer tests
2. Add error path tests
3. Edge case coverage
4. Target: 80% total coverage

## Success Metrics

- ✅ 100% test pass rate (302/302)
- ✅ 80%+ code coverage
- ✅ 0 critical paths untested
- ✅ All public APIs tested
- ✅ Error handling validated
- ✅ Integration tests stable

## Quick Wins (Today)

1. **Fix retrieval coordinator mocks** - Should fix 21 tests
2. **Fix retrieval mode config** - Should fix 18 tests
3. **Fix database cleanup** - Should fix 12 integration tests
4. **Add basic HTTP API tests** - 10-20% coverage boost

**Estimated**: 51 failing → 0 failing in 4-6 hours