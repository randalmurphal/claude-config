#!/usr/bin/env python3
"""
Interactive Forex Trader Knowledge Explorer
Demonstrates PRISM MCP's semantic search over indexed codebase
"""
import requests
import sys
from typing import List, Dict, Any

API_URL = "http://localhost:8090"
API_KEY = "prism_development_key_2024"

class ForexExplorer:
    def __init__(self):
        self.session = requests.Session()
        self.session.headers.update({
            "Authorization": f"Bearer {API_KEY}",
            "Content-Type": "application/json"
        })

    def query(self, question: str, top_k: int = 5, show_code: bool = False) -> List[Dict[str, Any]]:
        """Query the indexed forex trader knowledge"""
        payload = {
            "query": question,
            "top_k": top_k,
            "session_id": "forex_explorer",
            "context": {
                "task": "exploring forex_trader architecture",
                "project_id": "forex_trader"
            }
        }

        try:
            response = self.session.post(f"{API_URL}/api/retrieve_memories", json=payload)
            if response.status_code == 200:
                return response.json().get('memories', [])
            else:
                print(f"âŒ Query failed: {response.status_code}")
                print(f"   {response.text}")
                return []
        except Exception as e:
            print(f"âŒ Error: {e}")
            return []

    def display_results(self, results: List[Dict], show_code: bool = False):
        """Pretty print query results"""
        if not results:
            print("\nâŒ No results found\n")
            return

        print(f"\nâœ… Found {len(results)} relevant memories:\n")

        for i, mem in enumerate(results, 1):
            memory_type = mem.get('memory_type', 'unknown')
            content = mem.get('content', '')
            context = mem.get('context', {})
            similarity = mem.get('similarity_score', 0.0)

            # Icon based on type
            icon = "ðŸ“" if memory_type == "research_note" else "ðŸ’»"

            print(f"{icon} [{i}] {memory_type.upper()}")

            if context.get('symbol_name'):
                symbol_type = context.get('symbol_type', 'symbol')
                file_path = context.get('file_path', 'unknown')
                print(f"   Symbol: {context['symbol_name']} ({symbol_type})")
                print(f"   File: {file_path}")

            if context.get('module_name'):
                print(f"   Module: {context['module_name']}")

            # Show snippet
            snippet_length = 300 if not show_code else 1000
            snippet = content[:snippet_length]
            if len(content) > snippet_length:
                snippet += "..."

            print(f"   Preview:")
            for line in snippet.split('\n')[:10]:
                print(f"      {line}")

            print(f"   Similarity: {similarity:.3f}")
            print()

    def demo_queries(self):
        """Run demo queries to showcase capabilities"""
        queries = [
            ("How does risk management work?", False),
            ("Show me trade evaluation logic", True),
            ("What are the data models for positions?", False),
            ("How is backtesting implemented?", False),
            ("Show me the forex simulation code", True),
        ]

        for query, show_code in queries:
            print("="*70)
            print(f"ðŸ” QUERY: {query}")
            print("="*70)

            results = self.query(query, top_k=3, show_code=show_code)
            self.display_results(results, show_code=show_code)

            input("\nâŽ Press Enter for next query...\n")

    def interactive(self):
        """Interactive query mode"""
        print("="*70)
        print("ðŸŽ¯ Interactive Forex Trader Explorer")
        print("="*70)
        print("\nType your questions or commands:")
        print("  â€¢ Ask natural language questions")
        print("  â€¢ 'demo' - Run demo queries")
        print("  â€¢ 'quit' - Exit")
        print()

        while True:
            try:
                query = input("ðŸ” Query: ").strip()

                if not query:
                    continue

                if query.lower() in ['quit', 'exit', 'q']:
                    print("\nðŸ‘‹ Goodbye!\n")
                    break

                if query.lower() == 'demo':
                    self.demo_queries()
                    continue

                # Check if user wants to see code
                show_code = 'code' in query.lower() or 'show' in query.lower()

                results = self.query(query, top_k=5, show_code=show_code)
                self.display_results(results, show_code=show_code)

            except KeyboardInterrupt:
                print("\n\nðŸ‘‹ Goodbye!\n")
                break
            except Exception as e:
                print(f"\nâŒ Error: {e}\n")

def main():
    explorer = ForexExplorer()

    if len(sys.argv) > 1 and sys.argv[1] == 'demo':
        explorer.demo_queries()
    else:
        explorer.interactive()

if __name__ == "__main__":
    main()