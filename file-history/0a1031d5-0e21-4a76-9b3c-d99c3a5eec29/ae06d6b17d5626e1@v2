#!/usr/bin/env python3
"""
Quick test of Jina Reranker API

Tests jina-reranker-m0 to see:
- Does the API work?
- What's the latency like?
- How much does reranking improve results?
"""

import os
import sys
import time

print("="*80)
print("JINA RERANKER API QUICK TEST")
print("="*80)

# Check for API key
api_key = os.getenv("JINA_API_KEY")
if not api_key:
    print("\n‚ö†Ô∏è  JINA_API_KEY not set!")
    print("Set it with: export JINA_API_KEY='jina_xxx'")
    sys.exit(1)

# Try to import jina
try:
    import requests
except ImportError:
    print("‚ö†Ô∏è  requests package not installed")
    sys.exit(1)

print("\n1. Testing Jina Reranker API...")

# Sample query and documents
query = "How to implement JWT authentication with refresh tokens in Python?"

documents = [
    "JWT tokens are used for stateless authentication in web applications",
    "Refresh tokens allow users to obtain new access tokens without re-authenticating",
    "Python's PyJWT library provides JWT encoding and decoding functionality",
    "OAuth2 uses authorization codes to obtain access tokens securely",
    "Database connection pooling improves application performance",
    "Async/await syntax in Python enables concurrent programming",
    "Flask and FastAPI are popular Python web frameworks",
    "JWT authentication requires proper token validation and expiration handling",
    "Redis can be used to store refresh tokens for fast lookup",
    "Password hashing with bcrypt protects user credentials",
]

print(f"   Query: {query[:60]}...")
print(f"   Documents: {len(documents)} to rerank")

# Call Jina reranker API
start_time = time.time()

response = requests.post(
    'https://api.jina.ai/v1/rerank',
    headers={
        'Content-Type': 'application/json',
        'Authorization': f'Bearer {api_key}'
    },
    json={
        'model': 'jina-reranker-v2-base-multilingual',  # Free tier model
        'query': query,
        'documents': documents,
        'top_n': 5,
    },
    timeout=30
)

latency = (time.time() - start_time) * 1000

if response.status_code != 200:
    print(f"\n‚ùå API request failed: {response.status_code}")
    print(f"   Response: {response.text}")
    sys.exit(1)

result = response.json()

print(f"\n2. Results:")
print(f"   ‚úì Latency: {latency:.0f}ms")
print(f"   ‚úì Model: {result.get('model', 'N/A')}")
print(f"   ‚úì Usage: {result.get('usage', {})}")

print(f"\n3. Top 5 reranked results:")
for i, doc in enumerate(result['results'][:5], 1):
    relevance = doc.get('relevance_score', 0)
    idx = doc.get('index', -1)
    text = documents[idx] if idx < len(documents) else "Unknown"
    print(f"   {i}. [{relevance:.3f}] {text[:70]}...")

print("\n" + "="*80)
print("RESULTS")
print("="*80)
print(f"\n‚úÖ Jina Reranker API is working!")
print(f"\nLatency: ~{latency:.0f}ms for reranking {len(documents)} documents")
print(f"\nüí° Reranking helps by:")
print(f"   - Reordering results by semantic relevance")
print(f"   - +10-15% precision improvement typically")
print(f"   - Most relevant results surface to the top")
print(f"\nüìä Quality Assessment:")

# Show how results changed
original_order = list(range(len(documents)))[:5]
reranked_order = [doc['index'] for doc in result['results'][:5]]

print(f"   Original order: {original_order}")
print(f"   Reranked order: {reranked_order}")
print(f"   Changed: {'Yes - reranking made a difference!' if original_order != reranked_order else 'No change needed'}")

print("\n" + "="*80)
print("‚úì Both Voyage and Jina APIs are ready!")
print("  Next: Full comparison test after pattern loading completes")
print("="*80)