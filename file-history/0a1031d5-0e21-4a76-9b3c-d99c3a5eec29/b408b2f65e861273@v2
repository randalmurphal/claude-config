#!/usr/bin/env python3
"""
Test script: Index the prism_mcp codebase to validate indexing works.

This tests the codebase-first approach with OUR actual code.
"""
import sys
from pathlib import Path

# Add prism_mcp to path
prism_path = Path("/home/randy/repos/claude_mcp/prism_mcp")
sys.path.insert(0, str(prism_path))

from prism_mcp.utils.config import load_config
from prism_mcp.core.index_manager import IndexManager
import uuid

def main():
    print("üîç Testing codebase indexing with prism_mcp...")
    print(f"   Target: {prism_path}")

    # Load config first (NO DEFAULTS philosophy)
    _ = load_config()
    print("   Config loaded\n")

    # Initialize manager
    manager = IndexManager()

    # Generate IDs
    project_id = "prism_mcp_test"
    session_id = str(uuid.uuid4())

    print(f"   Project ID: {project_id}")
    print(f"   Session ID: {session_id}\n")

    # Check if already indexed
    existing_state = manager.get_index_state(project_id)
    if existing_state:
        print(f"‚ö†Ô∏è  Already indexed:")
        print(f"   Files: {existing_state.file_count}")
        print(f"   Symbols: {existing_state.symbol_count}")
        print(f"   Git SHA: {existing_state.last_indexed_sha}")
        print(f"   Last updated: {existing_state.last_updated}")
        print(f"\n   Run incremental_update() to sync changes\n")
        return

    # Start full index
    print("Starting full index (this will take 1-2 minutes for 118 files)...\n")

    result = manager.start_full_index(
        project_path=str(prism_path),
        project_id=project_id,
        session_id=session_id
    )

    print("\n‚úÖ Indexing complete!")
    print(f"   Files indexed: {result['files_indexed']}")
    print(f"   Symbols extracted: {result['symbols_extracted']}")
    print(f"   Git SHA: {result['git_sha']}")
    print(f"   Duration: {result['duration_seconds']:.2f}s")
    print(f"   File watching: {result.get('file_watching_started', False)}")

    print("\nüéØ Now PRISM knows YOUR code patterns!")
    print("   Try asking Claude about prism_mcp architecture")

if __name__ == "__main__":
    main()