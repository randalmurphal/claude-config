# Project Indexer - Integration Guide

## âœ… Created
- `/home/randy/repos/claude_mcp/prism_mcp/prism_mcp/services/project_indexer.py`
  - Production-ready project indexer
  - Handles Python, JS/TS, Go, docs
  - Batching, progress tracking, error handling
  - Idempotent operations

## ðŸ”§ Need to Add

### 1. HTTP API Endpoint (`prism_mcp/interfaces/http_api.py`)

Add after existing endpoints (~line 800):

```python
@self.app.post('/api/index_project')
async def index_project(
    request: IndexProjectRequest,
    token: str = Depends(self._verify_token),
):
    """Index an entire project for semantic search."""
    from prism_mcp.services.project_indexer import ProjectIndexer

    indexer = ProjectIndexer(storage_manager=self.orchestrator.memory_engine)

    try:
        progress = indexer.index_project(
            root_dir=request.root_dir,
            project_id=request.project_id,
            session_id=request.session_id or "project_indexing",
            include_docs=request.include_docs,
            include_tests=request.include_tests,
            max_file_size_kb=request.max_file_size_kb or 500,
            batch_size=request.batch_size or 10
        )
        return progress.to_dict()
    except Exception as e:
        logger.error(f'Index project failed: {e}')
        raise HTTPException(status_code=500, detail=str(e))
```

### 2. Request Model (`prism_mcp/interfaces/http_api.py`, ~line 100)

```python
class IndexProjectRequest(BaseModel):
    root_dir: str
    project_id: Optional[str] = None
    session_id: Optional[str] = None
    include_docs: bool = True
    include_tests: bool = False
    max_file_size_kb: int = 500
    batch_size: int = 10
```

### 3. MCP Tool (`prism_mcp/interfaces/mcp_server.py`, in list_tools())

```python
Tool(
    name='prism_index_project',
    description='Index an entire project (code + docs) for semantic search. Handles large monorepos.',
    inputSchema={
        'type': 'object',
        'properties': {
            'root_dir': {
                'type': 'string',
                'description': 'Root directory to index'
            },
            'project_id': {
                'type': 'string',
                'description': 'Optional project identifier (defaults to dir name)'
            },
            'include_docs': {
                'type': 'boolean',
                'default': True,
                'description': 'Index documentation files (MD, RST, TXT)'
            },
            'include_tests': {
                'type': 'boolean',
                'default': False,
                'description': 'Index test files'
            }
        },
        'required': ['root_dir'],
    },
),
```

### 4. MCP Tool Handler (`prism_mcp/interfaces/mcp_server.py`, in call_tool())

```python
elif name == 'prism_index_project':
    result = self.http_client.index_project(
        root_dir=arguments['root_dir'],
        project_id=arguments.get('project_id'),
        include_docs=arguments.get('include_docs', True),
        include_tests=arguments.get('include_tests', False)
    )
    return [TextContent(
        type='text',
        text=json.dumps(result, indent=2)
    )]
```

### 5. HTTP Client Method (`prism_mcp/interfaces/http_client.py`)

```python
def index_project(
    self,
    root_dir: str,
    project_id: Optional[str] = None,
    include_docs: bool = True,
    include_tests: bool = False
) -> dict:
    """Index an entire project"""
    response = self.session.post(
        f"{self.base_url}/api/index_project",
        json={
            'root_dir': root_dir,
            'project_id': project_id,
            'include_docs': include_docs,
            'include_tests': include_tests
        }
    )
    response.raise_for_status()
    return response.json()
```

## ðŸš€ Usage

### From Claude Code (MCP):
```
Use tool: prism_index_project
Arguments: {"root_dir": "/home/user/my_project"}
```

### From HTTP API:
```bash
curl -X POST http://localhost:8090/api/index_project \
  -H "Authorization: Bearer prism_development_key_2024" \
  -H "Content-Type: application/json" \
  -d '{
    "root_dir": "/home/randy/repos/forex_trader",
    "project_id": "forex_trader",
    "include_docs": true,
    "include_tests": false
  }'
```

### From Python:
```python
from prism_mcp.services.project_indexer import ProjectIndexer
from prism_mcp.core.memory_engine import MemoryEngine

memory_engine = MemoryEngine()
indexer = ProjectIndexer(storage_manager=memory_engine)

progress = indexer.index_project(
    root_dir="/home/randy/repos/forex_trader",
    project_id="forex_trader"
)

print(f"Indexed {progress.indexed_memories} memories from {progress.total_files} files")
```

## âœ¨ Features

### Multi-Language Support
- Python: Classes, functions, module docs
- JavaScript/TypeScript: (file-level summaries for now)
- Go, Rust, Java: (file-level summaries)
- Documentation: MD, RST, TXT (split by sections)

### Smart Filtering
- Skips: node_modules, .git, venv, build, dist, cache, logs
- Size limits: Configurable max file size (default 500KB)
- Test files: Optional inclusion

### Production Ready
- **Batching**: Processes files in batches (default 10)
- **Progress tracking**: Real-time statistics
- **Error handling**: Continues on errors, reports counts
- **Idempotent**: Safe to re-run on same project

### What Gets Indexed

For **Python**:
1. Module docstrings â†’ `research_note`
2. Classes with code â†’ `code_pattern`
3. Class docstrings â†’ `research_note`
4. Public functions â†’ `code_pattern`

For **Documentation**:
1. Markdown sections â†’ `research_note`
2. Text files â†’ `research_note`

For **Other Languages**:
1. File summaries â†’ `code_pattern`

## ðŸŽ¯ Next Steps

1. Apply the above changes to integrate the indexer
2. Test with forex_trader project
3. Restart PRISM API server
4. Test MCP tool from Claude Code
5. Celebrate! ðŸŽ‰