"""
Tests for tech update data models.

Tests NO DEFAULTS validation and data integrity.
"""

import pytest
from datetime import datetime

from prism_mcp.models.tech_update import (
    Technology,
    TechUpdate,
    CriticalUpdate,
    ADRLink,
    UpdateSuggestion,
    ScanResult,
)


class TestTechnology:
    """Test Technology data model."""

    def test_technology_valid(self):
        """Test creating valid Technology."""
        tech = Technology(
            name='FastAPI',
            category='framework',
            current_version='0.104.1',
            sentiment='prefer',
            priority=5,
        )

        assert tech.name == 'FastAPI'
        assert tech.category == 'framework'
        assert tech.priority == 5

    def test_technology_missing_name_crashes(self):
        """Test that missing name crashes."""
        with pytest.raises(RuntimeError) as exc_info:
            Technology(name='', category='framework')

        assert 'name required' in str(exc_info.value)

    def test_technology_missing_category_crashes(self):
        """Test that missing category crashes."""
        with pytest.raises(RuntimeError) as exc_info:
            Technology(name='FastAPI', category='')

        assert 'category required' in str(exc_info.value)

    def test_technology_invalid_priority_crashes(self):
        """Test that invalid priority crashes."""
        with pytest.raises(RuntimeError) as exc_info:
            Technology(name='FastAPI', category='framework', priority=10)

        assert 'priority must be 1-5' in str(exc_info.value)

    def test_technology_invalid_sentiment_crashes(self):
        """Test that invalid sentiment crashes."""
        with pytest.raises(RuntimeError) as exc_info:
            Technology(name='FastAPI', category='framework', sentiment='love')

        assert 'sentiment must be prefer/avoid/neutral' in str(exc_info.value)


class TestTechUpdate:
    """Test TechUpdate data model."""

    def test_tech_update_valid(self):
        """Test creating valid TechUpdate."""
        update = TechUpdate(
            update_id='uuid-123',
            tech_name='FastAPI',
            update_type='security',
            severity='critical',
            title='Critical SQL injection',
            summary='SQL injection vulnerability in query parsing',
            impact='Update to 0.105.0 immediately',
            release_date=datetime.now(),
            source_url='https://github.com/tiangolo/fastapi/security',
            discovered_at=datetime.now(),
            cve_id='CVE-2024-12345',
        )

        assert update.tech_name == 'FastAPI'
        assert update.severity == 'critical'
        assert update.cve_id == 'CVE-2024-12345'

    def test_tech_update_missing_fields_crash(self):
        """Test that missing required fields crash."""
        # Missing update_id
        with pytest.raises(RuntimeError) as exc_info:
            TechUpdate(
                update_id='',
                tech_name='FastAPI',
                update_type='security',
                severity='critical',
                title='Test',
                summary='Test',
                impact='Test',
                release_date=datetime.now(),
                source_url='https://example.com',
                discovered_at=datetime.now(),
            )
        assert 'update_id required' in str(exc_info.value)

        # Invalid update_type
        with pytest.raises(RuntimeError) as exc_info:
            TechUpdate(
                update_id='uuid-123',
                tech_name='FastAPI',
                update_type='bugfix',  # Invalid
                severity='critical',
                title='Test',
                summary='Test',
                impact='Test',
                release_date=datetime.now(),
                source_url='https://example.com',
                discovered_at=datetime.now(),
            )
        assert 'update_type must be' in str(exc_info.value)


class TestCriticalUpdate:
    """Test CriticalUpdate data model."""

    def test_critical_update_valid(self):
        """Test creating valid CriticalUpdate."""
        update = CriticalUpdate(
            tech_name='FastAPI',
            severity='critical',
            title='Critical vulnerability',
            impact='Update immediately',
            source_url='https://example.com',
        )

        assert update.severity == 'critical'

    def test_critical_update_non_critical_severity_crashes(self):
        """Test that non-critical severity crashes."""
        with pytest.raises(RuntimeError) as exc_info:
            CriticalUpdate(
                tech_name='FastAPI',
                severity='high',  # Must be 'critical'
                title='Test',
                impact='Test',
                source_url='https://example.com',
            )

        assert 'severity must be critical' in str(exc_info.value)


class TestADRLink:
    """Test ADRLink data model."""

    def test_adr_link_valid(self):
        """Test creating valid ADRLink."""
        link = ADRLink(
            adr_id='adr-123',
            tech_name='FastAPI',
            decision='Use FastAPI for REST API',
            relevance=0.95,
            impact_assessment='Reconsider needed',
        )

        assert link.relevance == 0.95
        assert link.impact_assessment == 'Reconsider needed'

    def test_adr_link_invalid_relevance_crashes(self):
        """Test that invalid relevance crashes."""
        with pytest.raises(RuntimeError) as exc_info:
            ADRLink(
                adr_id='adr-123',
                tech_name='FastAPI',
                decision='Test',
                relevance=1.5,  # Must be 0.0-1.0
                impact_assessment='Test',
            )

        assert 'relevance must be 0.0-1.0' in str(exc_info.value)


class TestUpdateSuggestion:
    """Test UpdateSuggestion data model."""

    def test_update_suggestion_valid(self):
        """Test creating valid UpdateSuggestion."""
        suggestion = UpdateSuggestion(
            suggestion_id='sug-123',
            tech_name='FastAPI',
            suggestion_type='security_patch',
            priority='immediate',
            action='Apply security patch',
            reasoning='Critical vulnerability',
            effort_estimate='hours',
            related_adrs=['adr-123'],
        )

        assert suggestion.priority == 'immediate'
        assert len(suggestion.related_adrs) == 1

    def test_update_suggestion_invalid_type_crashes(self):
        """Test that invalid suggestion_type crashes."""
        with pytest.raises(RuntimeError) as exc_info:
            UpdateSuggestion(
                suggestion_id='sug-123',
                tech_name='FastAPI',
                suggestion_type='refactor',  # Invalid
                priority='immediate',
                action='Test',
                reasoning='Test',
                effort_estimate='hours',
            )

        assert 'suggestion_type must be' in str(exc_info.value)


class TestScanResult:
    """Test ScanResult data model."""

    def test_scan_result_valid(self):
        """Test creating valid ScanResult."""
        now = datetime.now()
        result = ScanResult(
            scan_id='scan-123',
            user_id='user-456',
            started_at=now,
            completed_at=now,
            technologies_scanned=50,
            updates_found=15,
            critical_count=2,
            high_count=5,
            medium_count=6,
            low_count=2,
            errors=[],
        )

        assert result.technologies_scanned == 50
        assert result.updates_found == 15

    def test_scan_result_negative_counts_crash(self):
        """Test that negative counts crash."""
        now = datetime.now()

        with pytest.raises(RuntimeError) as exc_info:
            ScanResult(
                scan_id='scan-123',
                user_id='user-456',
                started_at=now,
                completed_at=now,
                technologies_scanned=-1,  # Invalid
                updates_found=0,
                critical_count=0,
                high_count=0,
                medium_count=0,
                low_count=0,
            )

        assert 'technologies_scanned must be >= 0' in str(exc_info.value)