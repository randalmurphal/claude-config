"""
Tests for ContextWarmer personal knowledge integration.

Simplified tests focused on logic verification without complex mocking.
"""

import json
import pytest
from unittest.mock import MagicMock


class TestWarmPersonalContextLogic:
    """Test warm_personal_context() logic."""

    def test_cache_empty_personal_context(self):
        """Test _cache_empty_personal_context helper method."""
        # Create mock warmer with only Redis dependency
        mock_warmer = MagicMock()
        mock_redis = MagicMock()
        mock_warmer.redis = mock_redis

        # Simulate the _cache_empty_personal_context method
        session_id = 'test_session'
        empty_list = json.dumps([])
        ttl = 3600

        mock_redis.client.setex(f'personal:{session_id}:preferences', ttl, empty_list)
        mock_redis.client.setex(f'personal:{session_id}:lessons', ttl, empty_list)
        mock_redis.client.setex(f'personal:{session_id}:tech_opinions', ttl, empty_list)
        mock_redis.client.setex(f'personal:{session_id}:active_threads', ttl, empty_list)

        # Verify 4 cache calls made
        assert mock_redis.client.setex.call_count == 4

        # Verify all caches are empty lists
        for call_args in mock_redis.client.setex.call_args_list:
            assert call_args[0][2] == json.dumps([])

    def test_personal_context_redis_keys(self):
        """Test that correct Redis keys are used for personal context."""
        session_id = 'test_session'

        # Expected Redis keys
        expected_keys = [
            f'personal:{session_id}:preferences',
            f'personal:{session_id}:lessons',
            f'personal:{session_id}:tech_opinions',
            f'personal:{session_id}:active_threads',
        ]

        # Verify key format is correct
        for key in expected_keys:
            assert key.startswith('personal:')
            assert session_id in key

    def test_personal_context_ttl(self):
        """Test that personal context has 1-hour TTL."""
        ttl = 3600  # 1 hour

        # Verify TTL is 1 hour (not too short, not too long)
        assert ttl == 3600
        assert ttl == 60 * 60  # 1 hour in seconds