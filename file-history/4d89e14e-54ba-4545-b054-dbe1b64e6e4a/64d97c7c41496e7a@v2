"""
GitHub API client for fetching release information.

Uses public GitHub API without authentication (rate limited but sufficient).
"""

import json
import urllib.request
import urllib.error
from dataclasses import dataclass
from typing import List, Optional


@dataclass
class Release:
    """GitHub release information."""
    version: str
    name: str
    body: str
    published_at: str
    prerelease: bool
    url: str


class GitHubClient:
    """Client for GitHub API release fetching."""

    def __init__(self, timeout: int = 10):
        """
        Initialize GitHub client.

        Args:
            timeout: Request timeout in seconds
        """
        self.timeout = timeout
        self.user_agent = 'TechScanner/1.0'

    def fetch_releases(
        self,
        owner: str,
        repo: str,
        limit: Optional[int] = None
    ) -> List[Release]:
        """
        Fetch releases from GitHub repository.

        Args:
            owner: Repository owner
            repo: Repository name
            limit: Maximum number of releases to fetch (default: all)

        Returns:
            List of releases, newest first

        Raises:
            RuntimeError: If GitHub API request fails
        """
        url = f'https://api.github.com/repos/{owner}/{repo}/releases'

        try:
            req = urllib.request.Request(url)
            req.add_header('Accept', 'application/vnd.github.v3+json')
            req.add_header('User-Agent', self.user_agent)

            with urllib.request.urlopen(req, timeout=self.timeout) as response:
                data = json.loads(response.read())

                releases = []
                for release in data:
                    releases.append(Release(
                        version=release['tag_name'].lstrip('v'),
                        name=release.get('name', ''),
                        body=release.get('body', ''),
                        published_at=release.get('published_at', ''),
                        prerelease=release.get('prerelease', False),
                        url=release.get('html_url', '')
                    ))

                if limit:
                    releases = releases[:limit]

                return releases

        except urllib.error.HTTPError as e:
            error_body = e.read().decode('utf-8', errors='ignore')
            raise RuntimeError(
                f'GitHub API request failed: {e.code} {e.reason}\n'
                f'URL: {url}\n'
                f'Response: {error_body}\n'
                f'Fix: Check repository owner/name, or wait for rate limit reset'
            )
        except urllib.error.URLError as e:
            raise RuntimeError(
                f'Network error fetching GitHub releases: {e.reason}\n'
                f'URL: {url}\n'
                f'Fix: Check internet connection'
            )
        except json.JSONDecodeError as e:
            raise RuntimeError(
                f'Invalid JSON response from GitHub: {e}\n'
                f'URL: {url}\n'
                f'Fix: GitHub API may be down, try again later'
            )
        except Exception as e:
            raise RuntimeError(
                f'Unexpected error fetching GitHub releases: {e}\n'
                f'URL: {url}'
            )

    def filter_security_releases(
        self,
        releases: List[Release],
        keywords: Optional[List[str]] = None
    ) -> List[Release]:
        """
        Filter releases that mention security issues.

        Args:
            releases: List of releases to filter
            keywords: Security keywords to search for (default: common terms)

        Returns:
            Filtered list of security-related releases
        """
        if keywords is None:
            keywords = ['security', 'cve', 'vulnerability', 'exploit', 'injection']

        security_releases = []
        for release in releases:
            body_lower = release.body.lower()
            if any(keyword in body_lower for keyword in keywords):
                security_releases.append(release)

        return security_releases