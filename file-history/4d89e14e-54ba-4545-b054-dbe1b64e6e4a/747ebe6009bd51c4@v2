# Personal Claude - Revised Implementation Plan

**Based on:** Architecture validation + dependency analysis
**Date:** 2025-09-30

## Critical Issues Found

### 1. Memory Type Duplication
- `user_preference` duplicates existing `PreferenceManager` (540 lines)
- `lesson_learned` duplicates high-frustration corrections
- `tech_opinion` overlaps with ADRs

**Solution:** Extend existing systems, don't duplicate

### 2. ID System Conflicts
- Current: 12-char hex (legacy) vs UUID (preferences)
- New types need consistent UUIDs
- Need migration strategy

### 3. Graph Projection Impact
- New relationships require projection updates
- Risk of breaking PageRank

## Revised Architecture

### Week 0: Foundation Sprint (NEW - 3 days)

Build common infrastructure before new engines:

```
Foundation Components (can build in parallel):
├── PersonalMemory dataclass (extends Memory)
├── PersonalIDManager (consistent UUID generation)
├── RelationshipManager (specialized Neo4j relationships)
├── UserContextManager (centralized user identity)
└── PreferenceManager extensions (personal fields)
```

### Week 1-2: Core Personal Knowledge (Modified)

Focus on truly NEW functionality:
- User terminology dictionary
- Conversation threads
- Tech opinion tracking (non-ADR sentiment)

Reuse existing:
- PreferenceManager (extend, don't duplicate)
- Correction system (for lessons learned)

## Revised Phase 1 Plan

### Foundation Sprint: 3 Components in Parallel

**Component 1: Memory System Extensions**
- File: `prism_mcp/models/personal_memory.py`
- Tasks:
  - Create `PersonalMemory` dataclass extending `Memory`
  - Add fields: user_id, personal_category, confidence, evidence_count
  - Update `Memory.to_dict()` for new fields

**Component 2: ID Management**
- File: `prism_mcp/core/id_manager.py`
- Tasks:
  - Create `PersonalIDManager` class
  - Consistent UUID generation with prefixes
  - Update `PrismEngine._generate_memory_id()` to use it

**Component 3: Relationship Management**
- File: `prism_mcp/storage/relationship_manager.py`
- Tasks:
  - Create `RelationshipManager` class
  - Support for: SUPERSEDES, EVOLVED_FROM, APPLIES_TO, DERIVED_FROM
  - Update graph projections to include new relationships

**Component 4: User Context**
- File: `prism_mcp/core/user_context.py`
- Tasks:
  - Create `UserContextManager` class
  - User ID from env variable or config
  - Centralized user context retrieval

**Component 5: PreferenceManager Extensions**
- File: `prism_mcp/core/preference_manager.py` (modify existing)
- Tasks:
  - Add personal preference fields
  - Add `store_personal_preference()` method
  - Support preference evolution tracking

## Build Order (Post-Foundation)

### Phase 1A: Storage Extensions (2 hours, 3 agents parallel)
- Extend QdrantManager for personal collections
- Extend Neo4jManager for personal relationships
- Extend RedisCache for personal context

### Phase 1B: PersonalKnowledgeEngine Core (8 hours, 1 agent - BOTTLENECK)
- Implement truly new features:
  - User term storage/translation
  - Thread creation/tracking
  - Tech opinion (non-ADR)
- Delegate to existing systems:
  - Preferences → PreferenceManager
  - Lessons → Correction system with frustration_score

**Mitigation:** Create stub methods first (30 min) to unblock API work

### Phase 1C: HTTP API Endpoints (1 hour, 8 agents parallel)
- Each agent writes to separate temp file
- Merge agent combines into `http_api.py`
- Endpoints:
  - `/api/personal/terms/*`
  - `/api/personal/threads/*`
  - `/api/personal/tech-opinions/*`
  - `/api/personal/context` (unified)

### Phase 1D: Tests (3 hours, 7 agents parallel)
- 95% tests mocked (no database dependency)
- Only 1 integration test requires real databases
- 7x speedup through parallelization

## Total Timeline

- **Foundation:** 3 days (parallel work)
- **Phase 1:** 14 hours (56% speedup vs 32h sequential)
- **Total:** ~5 days for Phase 1

## What We're NOT Building

Based on architecture feedback, these are delegated to existing systems:

❌ `user_preference` memory type → Use `PreferenceManager.store_personal_preference()`
❌ `lesson_learned` memory type → Use high-frustration corrections
❌ Duplicate preference lifecycle → Extend existing lifecycle
❌ Separate preference storage → Use existing Qdrant collections

## What We ARE Building

✅ `user_term` memory type (truly new)
✅ `thread` memory type (truly new)
✅ `tech_opinion` memory type (sentiment tracking, not decisions)
✅ `tech_update` memory type (web monitoring)
✅ PersonalKnowledgeEngine (terminology + threads + tech opinions)
✅ TechEvolutionMonitor (web search + update detection)
✅ KnowledgePortability (export/import)

## Success Criteria

### Foundation Complete When:
- [ ] PersonalMemory dataclass created and tested
- [ ] PersonalIDManager generates consistent UUIDs
- [ ] RelationshipManager creates typed relationships
- [ ] UserContextManager retrieves user identity
- [ ] PreferenceManager extended with personal fields
- [ ] All foundation tests passing (100% coverage)

### Phase 1 Complete When:
- [ ] User terms stored and translated
- [ ] Threads created and tracked
- [ ] Tech opinions stored and retrieved
- [ ] HTTP API endpoints functional
- [ ] 95%+ test coverage
- [ ] Integration test with real PrismEngine passes

## Next Steps

1. Launch 5 parallel implementation agents for foundation components
2. Run tests after each component
3. Validate integration with existing PrismEngine
4. Once foundation solid, launch Phase 1 parallel agents