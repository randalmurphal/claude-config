#!/usr/bin/env python3
"""
End-to-end test with PRISM integration.

Tests the complete scanner pipeline with real PRISM HTTP API.
"""

import json
from scanner import GitHubClient, PatternExtractor, CodeScanner, compare_versions
from integrations import PRISMClient


def main():
    print("=" * 80)
    print("TECH SCANNER + PRISM INTEGRATION TEST")
    print("=" * 80)

    # Configuration
    tech = {
        'name': 'FastAPI',
        'github_owner': 'tiangolo',
        'github_repo': 'fastapi',
        'current_version': '0.100.0'
    }
    project = '/home/randy/repos/claude_mcp/prism_mcp'
    prism_url = 'http://localhost:8090'
    prism_api_key = 'prism_development_key_2024'

    print(f"\nğŸ“¦ Technology: {tech['name']}")
    print(f"ğŸ“ Current Version: {tech['current_version']}")
    print(f"ğŸ“ Project: {project}")
    print(f"ğŸ”— PRISM: {prism_url}")

    # Step 1: Verify PRISM is available
    print("\n" + "-" * 80)
    print("STEP 1: Verify PRISM Connection")
    print("-" * 80)

    prism = PRISMClient(prism_url, prism_api_key)
    prism_available = prism.check_health()

    if prism_available:
        print("âœ… PRISM is available and healthy")
    else:
        print("âŒ PRISM is not available")
        print("Fix: Ensure PRISM server is running on port 8090")
        return

    # Step 2: Fetch releases from GitHub
    print("\n" + "-" * 80)
    print("STEP 2: Fetch Releases from GitHub")
    print("-" * 80)

    github = GitHubClient()
    releases = github.fetch_releases(
        tech['github_owner'],
        tech['github_repo'],
        limit=30
    )

    print(f"âœ… Fetched {len(releases)} releases")
    print(f"   Latest: {releases[0].version}")

    # Step 3: Filter security releases
    print("\n" + "-" * 80)
    print("STEP 3: Find Security Releases")
    print("-" * 80)

    security_releases = github.filter_security_releases(releases)
    newer_security = [
        r for r in security_releases
        if compare_versions(r.version, tech['current_version']) > 0
    ]

    print(f"âœ… Found {len(newer_security)} security releases newer than {tech['current_version']}")

    if newer_security:
        for i, rel in enumerate(newer_security[:3], 1):
            print(f"\n   {i}. {rel.version} - {rel.name}")
            print(f"      URL: {rel.url}")

    # Step 4: Extract patterns
    print("\n" + "-" * 80)
    print("STEP 4: Extract Patterns from Release Notes")
    print("-" * 80)

    extractor = PatternExtractor()
    all_patterns = []

    for release in newer_security[:5]:
        patterns = extractor.extract_patterns(release.body, release.version)
        all_patterns.extend(patterns)

    unique_patterns = extractor.deduplicate_patterns(all_patterns)

    print(f"âœ… Extracted {len(unique_patterns)} unique patterns:")
    for pattern_str, pattern_obj in list(unique_patterns.items())[:5]:
        print(f"\n   Pattern: {pattern_str}")
        print(f"   Confidence: {pattern_obj.confidence}")
        print(f"   Reason: {pattern_obj.reason}")

    # Step 5: Scan codebase
    print("\n" + "-" * 80)
    print("STEP 5: Scan Codebase for Patterns")
    print("-" * 80)

    scanner = CodeScanner(tech['name'])
    all_matches = []

    for pattern_str, pattern_obj in unique_patterns.items():
        matches = scanner.scan_project(
            project,
            pattern_str,
            pattern_obj.confidence,
            filter_tests=True
        )
        all_matches.extend(matches)

    print(f"âœ… Found {len(all_matches)} matches in code")

    # Show sample matches
    for match in all_matches[:3]:
        rel_path = match.file_path.replace(project, '.')
        print(f"\n   ğŸ“„ {rel_path}:{match.line_number}")
        print(f"      Confidence: {match.confidence:.2f}")
        print(f"      {match.line_content[:70]}")

    # Step 6: Get ADRs from PRISM
    print("\n" + "-" * 80)
    print("STEP 6: Link to Architecture Decisions (PRISM)")
    print("-" * 80)

    adrs = prism.get_tech_adrs(tech['name'], limit=5)

    if adrs:
        print(f"âœ… Found {len(adrs)} ADRs related to {tech['name']}:")
        for adr in adrs:
            print(f"\n   ğŸ“‹ {adr.title}")
            print(f"      File: {adr.file_path}")
            print(f"      Confidence: {adr.confidence:.2f}")
    else:
        print(f"âš ï¸  No ADRs found for {tech['name']}")
        print("   This is normal if you haven't indexed ADRs yet")

    # Step 7: Generate final report
    print("\n" + "=" * 80)
    print("FINAL SCAN REPORT")
    print("=" * 80)

    report = {
        'technology': tech['name'],
        'current_version': tech['current_version'],
        'releases_checked': len(releases),
        'security_releases_found': len(newer_security),
        'patterns_extracted': len(unique_patterns),
        'code_matches': len(all_matches),
        'related_adrs': len(adrs),
        'prism_available': prism_available
    }

    print(f"""
ğŸ“¦ Technology: {report['technology']}
ğŸ“ Current Version: {report['current_version']}

ğŸ“Š Scan Results:
   â€¢ Releases Checked: {report['releases_checked']}
   â€¢ Security Releases Found: {report['security_releases_found']}
   â€¢ Patterns Extracted: {report['patterns_extracted']}
   â€¢ Code Matches: {report['code_matches']}
   â€¢ Related ADRs: {report['related_adrs']}

ğŸ”— PRISM Integration: {'âœ… Working' if report['prism_available'] else 'âŒ Unavailable'}
""")

    # Recommendations
    print("ğŸ’¡ Recommendations:")
    if all_matches:
        print("   1. Review code matches to assess impact")
        print("   2. Check related ADRs for architectural constraints")
        print("   3. Test upgrades in isolated environment")
    else:
        print("   âœ… No vulnerable patterns found in your code")
        print("   ğŸ’¡ Consider upgrading for other improvements")

    # Save report
    report_file = '/tmp/tech_scan_report.json'
    with open(report_file, 'w') as f:
        json.dump({
            **report,
            'matches': [
                {
                    'file': m.file_path,
                    'line': m.line_number,
                    'pattern': m.pattern,
                    'confidence': m.confidence
                }
                for m in all_matches
            ],
            'adrs': [
                {
                    'title': a.title,
                    'file': a.file_path,
                    'confidence': a.confidence
                }
                for a in adrs
            ]
        }, f, indent=2)

    print(f"\nğŸ“„ Full report saved to: {report_file}")

    # Test summary
    print("\n" + "=" * 80)
    print("TEST SUMMARY")
    print("=" * 80)

    checks = [
        ('PRISM Connection', prism_available),
        ('GitHub API', len(releases) > 0),
        ('Security Detection', len(security_releases) > 0),
        ('Pattern Extraction', len(unique_patterns) > 0),
        ('Code Scanning', True),  # Always works
        ('PRISM Integration', prism_available),
    ]

    passed = sum(1 for _, status in checks if status)
    total = len(checks)

    for check_name, status in checks:
        icon = "âœ…" if status else "âŒ"
        print(f"{icon} {check_name}")

    print(f"\n{passed}/{total} checks passed")

    if passed == total:
        print("\nğŸ‰ All systems operational! Tech scanner is fully functional.")
    else:
        print(f"\nâš ï¸  {total - passed} check(s) failed. See above for details.")


if __name__ == '__main__':
    main()