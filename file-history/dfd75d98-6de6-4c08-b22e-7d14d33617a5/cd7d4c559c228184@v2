# Orchestration MCP Testing - Critical Findings

**Test Date:** 2025-09-29
**Test Project:** /tmp/test_orchestration (Task Queue System)
**Task ID:** a7561e6e-0573-4dd7-a0af-67324221c170

---

## Summary

Testing revealed **10 critical issues** with the orchestration system, ranging from documentation errors to a critical bug where the MCP server needs restarting to pick up code changes.

---

## CRITICAL ISSUES

### Issue #11: MCP Server Not Reloading Code ⚠️ **BLOCKER**

**Severity:** CRITICAL
**Component:** MCP Server (stdio protocol)

**Description:**
The MCP server runs as a persistent process via stdio protocol. Code changes to `workflow_coordinator.py` and other modules are NOT picked up until the MCP server restarts. This means all my V2 updates (validation, checkpoints) aren't actually running.

**Evidence:**
- Updated `finalize_phase()` returns: `{'success': bool, 'validation': dict, 'checkpoint': dict, ...}`
- Actual MCP response: `{'status': 'completed', 'modules_completed': [], ...}` (OLD format)
- This is the V1 response format, meaning old code is executing

**Impact:**
- Real validation NOT running (ValidationRunner not called)
- Checkpoints NOT being created
- Essentially running V1 code despite V2 updates

**Fix Required:**
1. Document that MCP server must be restarted after code changes
2. Or: Implement hot-reload mechanism
3. Or: Add version check to detect stale code

**Workaround:**
Restart Claude Code to restart the MCP server.

---

## DOCUMENTATION ISSUES

### Issue #1: Invalid complexity Value

**Severity:** HIGH
**Component:** Documentation (README.md, SIMPLE_USAGE.md)

**Problem:**
Documentation shows `complexity="auto"` but actual enum is `simple|medium|complex|massive`.

**Evidence:**
```python
# Documentation says:
start_task(complexity="auto")

# Actual validation error:
"'auto' is not one of ['simple', 'medium', 'complex', 'massive']"
```

**Fix:** Update all docs to show actual enum values, or implement "auto" detection in start_task.

---

### Issue #4: analyze_task_complexity Not a Standalone Tool

**Severity:** MEDIUM
**Component:** Documentation (README.md, SIMPLE_USAGE.md, conduct.md)

**Problem:**
Documentation mentions `analyze_task_complexity` as a standalone MCP tool, but it's only available integrated into `start_task`.

**Evidence:**
```python
# Documentation shows:
result = await mcp__orchestration__analyze_task_complexity(...)

# Actual error:
"No such tool available: mcp__orchestration__analyze_task_complexity"
```

**Fix:** Either:
1. Expose it as a standalone tool, OR
2. Remove references to standalone usage from docs

---

### Issue #5: "architecture" Phase Not Supported

**Severity:** HIGH
**Component:** Documentation + Implementation Mismatch

**Problem:**
workflows.yaml and README.md mention "architecture" as a phase for medium/large tasks, but `prepare_phase` only accepts: skeleton, implementation, testing, validation.

**Evidence:**
```yaml
# workflows.yaml medium:
phases:
  - architecture  # <-- This phase
  - skeleton
  - implementation

# But prepare_phase validation:
"'architecture' is not one of ['skeleton', 'implementation', 'testing', 'validation']"
```

**Impact:**
Cannot follow the documented medium/large workflows.

**Fix:** Either:
1. Add "architecture" to the valid phases enum, OR
2. Remove "architecture" from workflows.yaml and documentation

---

### Issue #8: validate_phase Tool Not Exposed

**Severity:** MEDIUM
**Component:** MCP Server

**Problem:**
`validate_phase` is documented as a standalone MCP tool but not actually exposed via MCP.

**Evidence:**
```python
# Documentation shows:
await mcp__orchestration__validate_phase(...)

# Actual error:
"No such tool available: mcp__orchestration__validate_phase"
```

**Fix:** Add `validate_phase` to MCP server tools (it exists in validation_runner.py but not exposed).

---

## IMPLEMENTATION ISSUES

### Issue #6: Agent Contexts Missing Specification Details

**Severity:** HIGH
**Component:** prepare_phase / Agent Context Generation

**Problem:**
Agent contexts are generic and don't include READY.md specification details. Agents only see "Implement main module for skeleton phase" without knowing it's a task queue system with specific requirements.

**Evidence:**
```json
{
  "PRIMARY": {
    "your_specific_task": "Implement main module for skeleton phase",
    "module_name": "main",
    // NO mention of task queue, priority support, retry logic, etc.
  }
}
```

**Impact:**
Agents don't have enough context to implement correctly. They'd have to read READY.md themselves or guess requirements.

**Fix:**
Include relevant READY.md sections in agent PRIMARY context:
- Requirements
- Proposed Approach
- Known Gotchas
- Success Criteria for this phase

---

### Issue #7: Duplicate Agents Created

**Severity:** MEDIUM
**Component:** prepare_phase

**Problem:**
Two duplicate agents created for the same "main" module (level 0 and level 1) with identical contexts.

**Evidence:**
```json
{
  "agents_to_launch": [
    {"module": "main", "level": 0, ...},
    {"module": "main", "level": 1, ...}  // Duplicate
  ]
}
```

**Impact:**
Wastes resources, confusing which agent to use, potential conflicts.

**Fix:**
Check module deduplication logic in chamber creation.

---

## VALIDATION ISSUES

### Issue #9: finalize_phase NOT Running Validation ⚠️ **CRITICAL**

**Severity:** CRITICAL
**Component:** finalize_phase (appears to be due to Issue #11)

**Problem:**
`finalize_phase` accepted my self-validation input and didn't run actual pytest/ruff/imports validation. This is the exact V1 broken behavior we fixed.

**Evidence:**
```python
# I passed self-validation:
validator_output = {"complete": true, "issues": [], "summary": "..."}

# System accepted it without question:
{"status": "completed", "ready_for_next_phase": true}

# NO validation was executed (no pytest run, no imports check)
```

**Root Cause:**
MCP server running old code (Issue #11).

**Impact:**
Validation system completely bypassed. Can proceed with broken code.

---

### Issue #10: No Checkpoint Created

**Severity:** CRITICAL
**Component:** finalize_phase (appears to be due to Issue #11)

**Problem:**
No git checkpoint was created after skeleton phase, despite workflows.yaml specifying checkpoints for skeleton in medium complexity.

**Evidence:**
```bash
$ git log --oneline
da5473e Add skeleton structure  # My manual commit
706b038 Add READY.md specification
1474e51 Initial commit
# No CHECKPOINT commits
```

**Root Cause:**
MCP server running old code (Issue #11).

**Impact:**
Cannot rollback to previous phases. Progress not preserved.

---

## INFRASTRUCTURE ISSUES

### Issue #2: Redis Port Not Initially Accessible

**Severity:** MEDIUM
**Component:** Database Setup

**Problem:**
Redis container running but port 6382 not accessible until restart with compose file.

**Evidence:**
```bash
$ redis-cli -p 6382 ping
Connection refused

$ nerdctl compose -f nerdctl-compose.yaml up -d prism-redis
$ redis-cli -p 6382 ping
PONG
```

**Impact:**
MCP tools fail on first use after reboot.

**Fix:**
Ensure containers started with compose file, not manually.

---

### Issue #3: Neo4j Takes Time to Start

**Severity:** LOW
**Component:** Database Setup

**Problem:**
Neo4j needs ~10 seconds to be ready after container start. Immediate MCP calls fail.

**Evidence:**
```
Error: Failed to read from defunct connection IPv4Address(('localhost', 7688))
```

**Fix:**
Add retry logic to Neo4j connection, or document wait time.

---

## TEST RESULTS

### What Worked ✅
1. **start_task** - Successfully created task and stored in Redis
2. **prepare_phase** - Created agent contexts and chambers
3. **Git repository** - Manual skeleton commit worked
4. **READY.md parsing** - Specification read correctly
5. **Database connections** - After restart, Redis and Neo4j accessible

### What Failed ❌
1. **Actual validation** - ValidationRunner never called
2. **Checkpoints** - No git commits created automatically
3. **Validation blocking** - Self-validation accepted without checks
4. **Documentation accuracy** - Multiple mismatches with implementation
5. **Agent contexts** - Missing specification details

---

## RECOMMENDED FIXES (Priority Order)

### P0 - Critical (Must Fix)
1. **Fix Issue #11** - MCP server code reload
   - Add hot-reload OR document restart requirement
   - Add version/timestamp check to detect stale code

2. **Fix Issue #9** - Ensure finalize_phase calls ValidationRunner
   - Already implemented in code, needs server restart to test

3. **Fix Issue #10** - Ensure checkpoints created
   - Already implemented in code, needs server restart to test

### P1 - High (Should Fix)
4. **Fix Issue #5** - Add "architecture" phase or remove from docs
5. **Fix Issue #6** - Include READY.md details in agent contexts
6. **Fix Issue #1** - Fix complexity enum documentation

### P2 - Medium (Nice to Fix)
7. **Fix Issue #4** - Expose analyze_task_complexity as standalone tool
8. **Fix Issue #7** - Fix duplicate agent creation
9. **Fix Issue #8** - Expose validate_phase as standalone tool

### P3 - Low (Polish)
10. **Fix Issue #2** - Document container startup requirements
11. **Fix Issue #3** - Add Neo4j connection retry

---

## NEXT STEPS

1. **Restart MCP Server** - Restart Claude Code to reload orchestration MCP
2. **Re-test Validation** - Run finalize_phase again after restart
3. **Verify Checkpoints** - Check if git commits created
4. **Test Implementation Phase** - Create actual code with tests
5. **Test Validation Blocking** - Intentionally fail tests to verify blocking works
6. **Fix Documentation** - Update all identified doc issues
7. **Fix Agent Contexts** - Include READY.md in PRIMARY context

---

## CONCLUSION

The **core V2 features are implemented correctly** in the code:
- ValidationRunner actually runs pytest/ruff/imports ✅
- CheckpointManager creates git commits ✅
- WorkflowCoordinator loads workflows.yaml and checks validation gates ✅

The **critical problem is Issue #11** - the MCP server is running stale code. Once restarted, validation and checkpoints should work as designed.

The **documentation issues are numerous** - at least 5 mismatches between docs and actual implementation.

The **agent context issue (#6) is significant** - agents don't get enough detail from READY.md to implement correctly.

**Overall Assessment:** System is 80% correct, but needs:
1. MCP server restart mechanism
2. Documentation fixes
3. Agent context improvements