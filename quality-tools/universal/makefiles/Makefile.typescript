# Makefile for TypeScript/React projects with comprehensive quality checks

.PHONY: all install test lint format typecheck coverage clean help validate security build analyze-bundle

# Variables
NPM := npm
NODE := node
MIN_COVERAGE := 80

# Colors
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[1;33m
NC := \033[0m

## help: Display this help message
help:
	@echo "Available targets:"
	@grep -E '^##' Makefile | sed 's/## //'

## all: Run all quality checks and build
all: validate build

## install: Install dependencies
install:
	@echo "$(GREEN)Installing dependencies...$(NC)"
	$(NPM) ci
	@echo "$(GREEN)✅ Dependencies installed$(NC)"

## install-dev: Install with dev dependencies
install-dev:
	@echo "$(GREEN)Installing all dependencies...$(NC)"
	$(NPM) install
	@echo "$(GREEN)✅ All dependencies installed$(NC)"

## format: Format code with Prettier
format:
	@echo "$(GREEN)Formatting code with Prettier...$(NC)"
	$(NPM) run format
	@echo "$(GREEN)✅ Code formatted$(NC)"

## format-check: Check code formatting
format-check:
	@echo "$(GREEN)Checking code formatting...$(NC)"
	$(NPM) run format:check
	@echo "$(GREEN)✅ Code formatting is correct$(NC)"

## lint: Run ESLint
lint:
	@echo "$(GREEN)Running ESLint...$(NC)"
	$(NPM) run lint
	@echo "$(GREEN)✅ Linting passed$(NC)"

## lint-fix: Fix linting issues
lint-fix:
	@echo "$(GREEN)Fixing linting issues...$(NC)"
	$(NPM) run lint:fix
	@echo "$(GREEN)✅ Linting issues fixed$(NC)"

## typecheck: Run TypeScript type checking
typecheck:
	@echo "$(GREEN)Running TypeScript type checker...$(NC)"
	$(NPM) run typecheck
	@echo "$(GREEN)✅ Type checking passed$(NC)"

## test: Run tests
test:
	@echo "$(GREEN)Running tests...$(NC)"
	$(NPM) test

## test-watch: Run tests in watch mode
test-watch:
	@echo "$(GREEN)Running tests in watch mode...$(NC)"
	$(NPM) run test:watch

## coverage: Run tests with coverage
coverage:
	@echo "$(GREEN)Running tests with coverage...$(NC)"
	$(NPM) run test:coverage
	@echo "$(GREEN)✅ Coverage report generated$(NC)"

## test-ci: Run tests in CI mode
test-ci:
	@echo "$(GREEN)Running tests in CI mode...$(NC)"
	$(NPM) run test:ci

## build: Build the project
build:
	@echo "$(GREEN)Building project...$(NC)"
	$(NPM) run build
	@echo "$(GREEN)✅ Build complete$(NC)"

## build-prod: Production build
build-prod:
	@echo "$(GREEN)Creating production build...$(NC)"
	NODE_ENV=production $(NPM) run build
	@echo "$(GREEN)✅ Production build complete$(NC)"

## dev: Start development server
dev:
	@echo "$(GREEN)Starting development server...$(NC)"
	$(NPM) run dev

## preview: Preview production build
preview:
	@echo "$(GREEN)Starting preview server...$(NC)"
	$(NPM) run preview

## analyze-bundle: Analyze bundle size
analyze-bundle: build
	@echo "$(GREEN)Analyzing bundle size...$(NC)"
	$(NPM) run analyze
	@echo "$(GREEN)✅ Bundle analysis complete$(NC)"

## security: Run security audit
security:
	@echo "$(GREEN)Running security audit...$(NC)"
	$(NPM) audit --audit-level=moderate
	@echo "$(GREEN)Checking for outdated packages...$(NC)"
	$(NPM) outdated || true
	@echo "$(GREEN)✅ Security check complete$(NC)"

## security-fix: Fix security vulnerabilities
security-fix:
	@echo "$(GREEN)Fixing security vulnerabilities...$(NC)"
	$(NPM) audit fix
	@echo "$(GREEN)✅ Security fixes applied$(NC)"

## validate: Run all validation checks
validate: format-check lint typecheck test coverage
	@echo "$(GREEN)✅ All validation checks passed!$(NC)"

## clean: Clean build artifacts
clean:
	@echo "$(YELLOW)Cleaning build artifacts...$(NC)"
	rm -rf dist build coverage .next out
	rm -rf node_modules/.cache
	rm -rf .eslintcache .prettiercache
	rm -rf coverage .nyc_output
	rm -rf storybook-static
	@echo "$(GREEN)✅ Cleaned$(NC)"

## clean-all: Clean everything including node_modules
clean-all: clean
	@echo "$(YELLOW)Removing node_modules...$(NC)"
	rm -rf node_modules package-lock.json
	@echo "$(GREEN)✅ All cleaned$(NC)"

## storybook: Start Storybook
storybook:
	@echo "$(GREEN)Starting Storybook...$(NC)"
	$(NPM) run storybook

## storybook-build: Build Storybook
storybook-build:
	@echo "$(GREEN)Building Storybook...$(NC)"
	$(NPM) run build-storybook
	@echo "$(GREEN)✅ Storybook built$(NC)"

## lighthouse: Run Lighthouse performance audit
lighthouse: build
	@echo "$(GREEN)Running Lighthouse audit...$(NC)"
	@which lighthouse > /dev/null || $(NPM) install -g lighthouse
	lighthouse http://localhost:3000 --output html --output-path ./lighthouse-report.html
	@echo "$(GREEN)✅ Lighthouse report generated: lighthouse-report.html$(NC)"

## deps-check: Check for dependency issues
deps-check:
	@echo "$(GREEN)Checking dependencies...$(NC)"
	@which depcheck > /dev/null || $(NPM) install -g depcheck
	depcheck
	@echo "$(GREEN)✅ Dependency check complete$(NC)"

## update-deps: Update dependencies interactively
update-deps:
	@echo "$(GREEN)Updating dependencies...$(NC)"
	@which npm-check-updates > /dev/null || $(NPM) install -g npm-check-updates
	ncu -i
	@echo "$(GREEN)✅ Dependencies updated$(NC)"

## docker-build: Build Docker image
docker-build:
	@echo "$(GREEN)Building Docker image...$(NC)"
	docker build -t myapp:latest .

## ci: Run CI pipeline locally
ci: install validate security build
	@echo "$(GREEN)✅ CI pipeline completed successfully$(NC)"

# Watch for changes and run tests
watch:
	@echo "$(GREEN)Watching for changes...$(NC)"
	$(NPM) run test:watch
