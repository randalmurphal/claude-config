#!/usr/bin/env bash
set -euo pipefail

# gitlab-comment-mr - Add a comment to a merge request
#
# Usage: gitlab-comment-mr <mr-iid> <comment-text>
# Example: gitlab-comment-mr 1234 "LGTM, approved"
#
# Returns: Comment ID and confirmation on success
# Exit codes: 0 = success, 1 = usage error, 2 = not found, 3 = API error, 4 = credentials missing

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CREDS_FILE="${SCRIPT_DIR}/.gitlab-credentials"

# Function to show credential setup instructions
show_credential_instructions() {
    cat >&2 <<'EOF'
❌ GitLab credentials not found or incomplete.

STOP: This script requires GitLab API credentials to be configured.

Please create the file: ~/.claude/scripts/.gitlab-credentials

With the following content:

    # GitLab API Credentials
    GITLAB_PERSONAL_ACCESS_TOKEN="your-token-here"
    GITLAB_API_URL="https://gitlab.com/api/v4"
    GITLAB_PROJECT_ID="your-project-id"

How to get these values:

1. GITLAB_PERSONAL_ACCESS_TOKEN:
   - Go to: https://gitlab.com/-/profile/personal_access_tokens
   - Create token with 'api' scope
   - Copy the token (starts with 'glpat-')

2. GITLAB_PROJECT_ID:
   - Go to your project on GitLab
   - Look under the project name (e.g., "Project ID: 29007973")

3. GITLAB_API_URL:
   - Use "https://gitlab.com/api/v4" for gitlab.com
   - Use your custom URL if self-hosted (e.g., "https://gitlab.yourcompany.com/api/v4")

After creating the file, this script will work automatically.
The credentials file is gitignored and will not be committed.

EOF
    exit 4
}

# Check if credentials file exists
if [ ! -f "$CREDS_FILE" ]; then
    echo "❌ Credentials file not found: $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

# Source credentials
# shellcheck source=/dev/null
source "$CREDS_FILE"

# Validate required credentials are set
if [ -z "${GITLAB_PERSONAL_ACCESS_TOKEN:-}" ]; then
    echo "❌ GITLAB_PERSONAL_ACCESS_TOKEN not set in $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

if [ -z "${GITLAB_PROJECT_ID:-}" ]; then
    echo "❌ GITLAB_PROJECT_ID not set in $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

# Set default API URL if not provided
GITLAB_API_URL="${GITLAB_API_URL:-https://gitlab.com/api/v4}"

# Parse arguments
mr_iid="${1:-}"
comment_text="${2:-}"

# Validate required arguments
if [ -z "$mr_iid" ] || [ -z "$comment_text" ]; then
    echo "Usage: gitlab-comment-mr <mr-iid> <comment-text>" >&2
    echo "Example: gitlab-comment-mr 1234 \"LGTM, approved\"" >&2
    exit 1
fi

# Build JSON payload
json_payload=$(jq -n \
    --arg body "$comment_text" \
    '{
        body: $body
    }')

# Add comment via GitLab API
response=$(curl -s -w "\n%{http_code}" \
    -H "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "$json_payload" \
    "${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/merge_requests/${mr_iid}/notes")

# Split response into body and status code
http_code=$(echo "$response" | tail -1)
body=$(echo "$response" | sed '$d')

# Check HTTP status
if [ "$http_code" = "404" ]; then
    echo "❌ Merge request not found: !${mr_iid}" >&2
    exit 2
elif [ "$http_code" = "401" ]; then
    echo "❌ Authentication failed. Check your GITLAB_PERSONAL_ACCESS_TOKEN" >&2
    exit 3
elif [ "$http_code" = "403" ]; then
    echo "❌ Access denied. You may not have permission to comment on this merge request." >&2
    exit 3
elif [[ ! "$http_code" =~ ^2[0-9][0-9]$ ]]; then
    echo "❌ GitLab API error (HTTP $http_code)" >&2
    error_msg=$(echo "$body" | jq -r '.message // "Unknown error"')
    echo "Error: $error_msg" >&2
    exit 3
fi

# Parse success response
comment_id=$(echo "$body" | jq -r '.id')
comment_author=$(echo "$body" | jq -r '.author.username')
comment_created=$(echo "$body" | jq -r '.created_at | split("T")[0]')

# Output success message
echo "✅ Comment added to MR !${mr_iid}"
echo ""
echo "Comment ID: ${comment_id}"
echo "Author: @${comment_author}"
echo "Created: ${comment_created}"
echo ""
echo "Comment text:"
echo "${comment_text}"
