#!/usr/bin/env bash
set -euo pipefail

# gitlab-reply-discussion - Reply to an existing discussion thread in a merge request
#
# Usage: gitlab-reply-discussion <ticket-id> <discussion-id> <reply-text>
# Example: gitlab-reply-discussion INT-4036 abc123def456 "Fixed - updated the code as suggested"
#
# Returns: Note ID and confirmation on success
# Exit codes: 0 = success, 1 = usage error, 2 = not found, 3 = API error, 4 = credentials missing

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CREDS_FILE="${SCRIPT_DIR}/.gitlab-credentials"

# Source credentials
if [ ! -f "$CREDS_FILE" ]; then
    echo "❌ Credentials file not found: $CREDS_FILE" >&2
    exit 4
fi

# shellcheck source=/dev/null
source "$CREDS_FILE"

# Validate credentials
if [ -z "${GITLAB_PERSONAL_ACCESS_TOKEN:-}" ] || [ -z "${GITLAB_PROJECT_ID:-}" ]; then
    echo "❌ GITLAB_PERSONAL_ACCESS_TOKEN or GITLAB_PROJECT_ID not set" >&2
    exit 4
fi

GITLAB_API_URL="${GITLAB_API_URL:-https://gitlab.com/api/v4}"

# Parse arguments
ticket="${1:-}"
discussion_id="${2:-}"
reply_text="${3:-}"

if [ -z "$ticket" ] || [ -z "$discussion_id" ] || [ -z "$reply_text" ]; then
    echo "Usage: gitlab-reply-discussion <ticket-id> <discussion-id> <reply-text>" >&2
    echo "Example: gitlab-reply-discussion INT-4036 abc123 \"Fixed as suggested\"" >&2
    echo "" >&2
    echo "Tip: Use gitlab-list-discussions <ticket-id> to get discussion IDs" >&2
    exit 1
fi

# Find source branch for ticket
source_branch=$(git branch -r 2>/dev/null | grep "origin/$ticket" | grep -v "pre-styling" | head -1 | sed 's|.*origin/||' | xargs)

if [ -z "$source_branch" ]; then
    echo "❌ No branch found for ticket: $ticket" >&2
    exit 1
fi

# Get MR for branch
mr_response=$(curl -s -H "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
    "${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/merge_requests?source_branch=${source_branch}&state=opened")

mr_iid=$(echo "$mr_response" | jq -r '.[0].iid // empty')

if [ -z "$mr_iid" ]; then
    # Try all states
    mr_response=$(curl -s -H "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
        "${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/merge_requests?source_branch=${source_branch}")
    mr_iid=$(echo "$mr_response" | jq -r '.[0].iid // empty')

    if [ -z "$mr_iid" ]; then
        echo "❌ No MR found for branch: $source_branch" >&2
        exit 2
    fi
fi

# Build JSON payload
json_payload=$(jq -n \
    --arg body "$reply_text" \
    '{
        body: $body
    }')

# Add reply to discussion via GitLab API
response=$(curl -s -w "\n%{http_code}" \
    -H "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "$json_payload" \
    "${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/merge_requests/${mr_iid}/discussions/${discussion_id}/notes")

# Split response into body and status code
http_code=$(echo "$response" | tail -1)
body=$(echo "$response" | sed '$d')

# Check HTTP status
if [ "$http_code" = "404" ]; then
    echo "❌ Discussion not found: ${discussion_id}" >&2
    echo "Tip: Use gitlab-list-discussions ${ticket} to see all discussion IDs" >&2
    exit 2
elif [ "$http_code" = "401" ]; then
    echo "❌ Authentication failed. Check your GITLAB_PERSONAL_ACCESS_TOKEN" >&2
    exit 3
elif [ "$http_code" = "403" ]; then
    echo "❌ Access denied. You may not have permission to comment on this discussion." >&2
    exit 3
elif [[ ! "$http_code" =~ ^2[0-9][0-9]$ ]]; then
    echo "❌ GitLab API error (HTTP $http_code)" >&2
    error_msg=$(echo "$body" | jq -r '.message // "Unknown error"')
    echo "Error: $error_msg" >&2
    exit 3
fi

# Parse success response
note_id=$(echo "$body" | jq -r '.id')
note_author=$(echo "$body" | jq -r '.author.username')
note_created=$(echo "$body" | jq -r '.created_at | split("T")[0]')

# Output success message
echo "✅ Reply added to discussion ${discussion_id}"
echo ""
echo "Note ID: ${note_id}"
echo "Author: @${note_author}"
echo "Created: ${note_created}"
echo "MR: !${mr_iid}"
echo ""
echo "Reply text:"
echo "${reply_text}"
