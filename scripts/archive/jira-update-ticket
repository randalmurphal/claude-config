#!/usr/bin/env bash
set -euo pipefail

# jira-update-ticket - Update fields on a Jira ticket or add comments
#
# Usage: jira-update-ticket <ticket-id> [options]
#
# Options:
#   --description <text>         Update description
#   --assignee <email>           Assign to user
#   --status <status>            Change status
#   --priority <priority>        Set priority
#   --labels <label1,label2>     Set labels (comma-separated)
#   --comment <text>             Add a comment
#   --write-test-plan <text>     Write to Test Plan field (customfield_11003)
#   --custom <field_id> <value>  Set custom field (e.g., customfield_10042)
#
# Examples:
#   jira-update-ticket INT-3877 --description "Updated description" --priority High
#   jira-update-ticket INT-3877 --status "In Progress" --assignee "user@example.com"
#   jira-update-ticket INT-3877 --comment "Work completed and tested"
#   jira-update-ticket INT-3877 --write-test-plan "$(cat test_plan.md)"
#   jira-update-ticket INT-3877 --custom customfield_10042 "Custom field text"
#
# Returns: Updated ticket details
# Exit codes: 0 = success, 1 = usage error, 2 = ticket not found, 3 = API error, 4 = credentials missing

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CREDS_FILE="${SCRIPT_DIR}/.jira-credentials"

# Function to show credential setup instructions
show_credential_instructions() {
    cat >&2 <<'EOF'
❌ Jira credentials not found or incomplete.

STOP: This script requires Jira API credentials to be configured.

The script uses the same credentials as the Jira MCP. Make sure these
environment variables are set:

    ATLASSIAN_API_TOKEN="your-token"
    ATLASSIAN_SITE_NAME="fortressinfosec"
    ATLASSIAN_USER_EMAIL="your.email@fortressinfosec.com"

These should already be set in your environment if the Jira MCP is working.

If not set, the credentials file (~/.claude/scripts/.jira-credentials) will
try to load them from the environment, but they must exist there first.

Check: env | grep ATLASSIAN

EOF
    exit 4
}

# Check if credentials file exists
if [ ! -f "$CREDS_FILE" ]; then
    echo "❌ Credentials file not found: $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

# Source credentials
# shellcheck source=/dev/null
source "$CREDS_FILE"

# Validate required credentials are set
if [ -z "${ATLASSIAN_API_TOKEN:-}" ]; then
    echo "❌ ATLASSIAN_API_TOKEN not set" >&2
    echo "" >&2
    show_credential_instructions
fi

if [ -z "${ATLASSIAN_USER_EMAIL:-}" ]; then
    echo "❌ ATLASSIAN_USER_EMAIL not set" >&2
    echo "" >&2
    show_credential_instructions
fi

if [ -z "${JIRA_INSTANCE_URL:-}" ]; then
    echo "❌ JIRA_INSTANCE_URL not set (needs ATLASSIAN_SITE_NAME)" >&2
    echo "" >&2
    show_credential_instructions
fi

# Get ticket ID
ticket="${1:-}"
if [ -z "$ticket" ]; then
    cat >&2 <<'EOF'
Usage: jira-update-ticket <ticket-id> [options]

Options:
  --description <text>         Update description
  --assignee <email>           Assign to user
  --status <status>            Change status
  --priority <priority>        Set priority
  --labels <label1,label2>     Set labels (comma-separated)
  --comment <text>             Add a comment
  --write-test-plan <text>     Write to Test Plan field
  --custom <field_id> <value>  Set custom field

Examples:
  jira-update-ticket INT-3877 --description "Updated description"
  jira-update-ticket INT-3877 --comment "Work completed"
  jira-update-ticket INT-3877 --write-test-plan "$(cat test_plan.md)"
  jira-update-ticket INT-3877 --custom customfield_10042 "Custom text"
EOF
    exit 1
fi

# Parse optional arguments
shift
update_description=""
update_assignee=""
update_status=""
update_priority=""
update_labels=""
update_comment=""
declare -A custom_fields

# Test Plan field ID mapping
TEST_PLAN_FIELD_ID="customfield_11003"

while [[ $# -gt 0 ]]; do
    case $1 in
        --description)
            update_description="$2"
            shift 2
            ;;
        --assignee)
            update_assignee="$2"
            shift 2
            ;;
        --status)
            update_status="$2"
            shift 2
            ;;
        --priority)
            update_priority="$2"
            shift 2
            ;;
        --labels)
            update_labels="$2"
            shift 2
            ;;
        --comment)
            update_comment="$2"
            shift 2
            ;;
        --write-test-plan)
            custom_fields["$TEST_PLAN_FIELD_ID"]="$2"
            shift 2
            ;;
        --custom)
            if [ -z "${2:-}" ] || [ -z "${3:-}" ]; then
                echo "❌ --custom requires two arguments: <field_id> <value>" >&2
                exit 1
            fi
            custom_fields["$2"]="$3"
            shift 3
            ;;
        *)
            echo "❌ Unknown option: $1" >&2
            echo "Valid options: --description, --assignee, --status, --priority, --labels, --comment, --write-test-plan, --custom" >&2
            exit 1
            ;;
    esac
done

# Remove trailing slash from instance URL if present
JIRA_INSTANCE_URL="${JIRA_INSTANCE_URL%/}"

# Build JSON payload for field updates (excluding status and comment)
payload_parts=()

if [ -n "$update_description" ]; then
    desc_json=$(jq -n \
        --arg desc "$update_description" \
        '{
            type: "doc",
            version: 1,
            content: [
                {
                    type: "paragraph",
                    content: [
                        {
                            type: "text",
                            text: $desc
                        }
                    ]
                }
            ]
        }')
    payload_parts+=("\"description\": $desc_json")
fi

if [ -n "$update_assignee" ]; then
    assignee_json=$(jq -n --arg email "$update_assignee" '{ emailAddress: $email }')
    payload_parts+=("\"assignee\": $assignee_json")
fi

if [ -n "$update_priority" ]; then
    priority_json=$(jq -n --arg priority "$update_priority" '{ name: $priority }')
    payload_parts+=("\"priority\": $priority_json")
fi

if [ -n "$update_labels" ]; then
    # Split comma-separated labels into array
    IFS=',' read -ra label_array <<< "$update_labels"
    labels_json=$(jq -n --argjson labels "$(printf '%s\n' "${label_array[@]}" | jq -R . | jq -s .)" '$labels')
    payload_parts+=("\"labels\": $labels_json")
fi

# Add custom fields
for field_id in "${!custom_fields[@]}"; do
    field_value="${custom_fields[$field_id]}"

    # Check if this is the Test Plan field - format as markdown code block
    if [ "$field_id" = "$TEST_PLAN_FIELD_ID" ]; then
        custom_json=$(jq -n \
            --arg value "$field_value" \
            '{
                type: "doc",
                version: 1,
                content: [
                    {
                        type: "codeBlock",
                        attrs: {
                            language: "markdown"
                        },
                        content: [
                            {
                                type: "text",
                                text: $value
                            }
                        ]
                    }
                ]
            }')
    else
        # Other custom fields: use ADF paragraph format
        custom_json=$(jq -n \
            --arg value "$field_value" \
            '{
                type: "doc",
                version: 1,
                content: [
                    {
                        type: "paragraph",
                        content: [
                            {
                                type: "text",
                                text: $value
                            }
                        ]
                    }
                ]
            }')
    fi
    payload_parts+=("\"$field_id\": $custom_json")
done

# Only proceed with field updates if there are any non-status/comment fields to update
if [ ${#payload_parts[@]} -gt 0 ]; then
    # Join payload parts with commas
    fields_json=$(IFS=','; echo "${payload_parts[*]}")
    payload="{\"fields\":{$fields_json}}"

    # Update issue via Jira API using Basic Auth (email:token)
    response=$(curl -s -w "\n%{http_code}" \
        -u "${ATLASSIAN_USER_EMAIL}:${ATLASSIAN_API_TOKEN}" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -X PUT \
        -d "$payload" \
        "${JIRA_INSTANCE_URL}/rest/api/3/issue/${ticket}")

    # Split response into body and status code
    http_code=$(echo "$response" | tail -1)
    body=$(echo "$response" | sed '$d')

    # Check HTTP status
    if [ "$http_code" = "404" ]; then
        echo "❌ Ticket not found: $ticket" >&2
        exit 2
    elif [ "$http_code" = "401" ]; then
        echo "❌ Authentication failed. Check your ATLASSIAN_API_TOKEN and ATLASSIAN_USER_EMAIL" >&2
        exit 3
    elif [ "$http_code" = "403" ]; then
        echo "❌ Access denied. You may not have permission to update this ticket." >&2
        exit 3
    elif [ "$http_code" = "400" ]; then
        echo "❌ Bad request. Check your input parameters." >&2
        error_msg=$(echo "$body" | jq -r '.errorMessages[]? // .errors? // .message? // "Unknown error"' 2>/dev/null || echo "Unknown error")
        echo "Error: $error_msg" >&2
        exit 3
    elif [[ ! "$http_code" =~ ^2[0-9][0-9]$ ]]; then
        echo "❌ Jira API error (HTTP $http_code)" >&2
        error_msg=$(echo "$body" | jq -r '.errorMessages[]? // .message? // "Unknown error"' 2>/dev/null || echo "Unknown error")
        echo "Error: $error_msg" >&2
        exit 3
    fi

    echo "✓ Updated ticket fields: ${ticket}"
fi

# Handle comment separately if provided
if [ -n "$update_comment" ]; then
    # Build JSON payload with ADF format
    comment_payload=$(jq -n \
        --arg comment "$update_comment" \
        '{
            body: {
                type: "doc",
                version: 1,
                content: [
                    {
                        type: "paragraph",
                        content: [
                            {
                                type: "text",
                                text: $comment
                            }
                        ]
                    }
                ]
            }
        }')

    # Add comment via Jira API
    comment_response=$(curl -s -w "\n%{http_code}" \
        -u "${ATLASSIAN_USER_EMAIL}:${ATLASSIAN_API_TOKEN}" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -X POST \
        -d "$comment_payload" \
        "${JIRA_INSTANCE_URL}/rest/api/3/issue/${ticket}/comment")

    comment_http_code=$(echo "$comment_response" | tail -1)
    comment_body=$(echo "$comment_response" | sed '$d')

    if [ "$comment_http_code" = "404" ]; then
        echo "❌ Ticket not found: $ticket" >&2
        exit 2
    elif [[ ! "$comment_http_code" =~ ^2[0-9][0-9]$ ]]; then
        echo "❌ Failed to add comment (HTTP $comment_http_code)" >&2
        error_msg=$(echo "$comment_body" | jq -r '.errorMessages[]? // .message? // "Unknown error"' 2>/dev/null || echo "Unknown error")
        echo "Error: $error_msg" >&2
        exit 3
    fi

    comment_id=$(echo "$comment_body" | jq -r '.id')
    echo "✓ Added comment (ID: ${comment_id})"
fi

# Handle status transition separately if provided
if [ -n "$update_status" ]; then
    # First, get available transitions
    trans_response=$(curl -s -w "\n%{http_code}" \
        -u "${ATLASSIAN_USER_EMAIL}:${ATLASSIAN_API_TOKEN}" \
        -H "Accept: application/json" \
        "${JIRA_INSTANCE_URL}/rest/api/3/issue/${ticket}/transitions")

    trans_http_code=$(echo "$trans_response" | tail -1)
    trans_body=$(echo "$trans_response" | sed '$d')

    if [[ ! "$trans_http_code" =~ ^2[0-9][0-9]$ ]]; then
        echo "❌ Failed to get available transitions (HTTP $trans_http_code)" >&2
        exit 3
    fi

    # Find transition ID for requested status
    transition_id=$(echo "$trans_body" | jq -r \
        --arg status "$update_status" \
        '.transitions[] | select(.to.name == $status or .name == $status) | .id' | head -1)

    if [ -z "$transition_id" ]; then
        echo "❌ Status transition '$update_status' not available for ticket $ticket" >&2
        available=$(echo "$trans_body" | jq -r '.transitions[].to.name' | tr '\n' ', ' | sed 's/,$//')
        echo "Available statuses: $available" >&2
        exit 3
    fi

    # Perform transition
    transition_payload=$(jq -n --arg tid "$transition_id" '{ transition: { id: $tid } }')

    trans_update_response=$(curl -s -w "\n%{http_code}" \
        -u "${ATLASSIAN_USER_EMAIL}:${ATLASSIAN_API_TOKEN}" \
        -H "Accept: application/json" \
        -H "Content-Type: application/json" \
        -X POST \
        -d "$transition_payload" \
        "${JIRA_INSTANCE_URL}/rest/api/3/issue/${ticket}/transitions")

    trans_update_code=$(echo "$trans_update_response" | tail -1)
    trans_update_body=$(echo "$trans_update_response" | sed '$d')

    if [ "$trans_update_code" = "404" ]; then
        echo "❌ Ticket not found: $ticket" >&2
        exit 2
    elif [[ ! "$trans_update_code" =~ ^2[0-9][0-9]$ ]]; then
        echo "❌ Failed to transition status (HTTP $trans_update_code)" >&2
        error_msg=$(echo "$trans_update_body" | jq -r '.errorMessages[]? // .message? // "Unknown error"' 2>/dev/null || echo "Unknown error")
        echo "Error: $error_msg" >&2
        exit 3
    fi

    echo "✓ Transitioned status to: ${update_status}"
fi

# Output success message
cat <<EOF

**Updated ticket:** ${ticket}
**View in Jira:** ${JIRA_INSTANCE_URL}/browse/${ticket}
EOF
