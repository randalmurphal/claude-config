#!/usr/bin/env bash
set -euo pipefail

# gitlab-list-mrs - List merge requests with filters
#
# Usage: gitlab-list-mrs [--state opened|closed|merged|all] [--author <username>] [--assignee <username>] [--labels <label1,label2>]
# Example: gitlab-list-mrs --state opened --author rmurphy
# Example: gitlab-list-mrs --assignee alice --labels bug,urgent
#
# Returns: Formatted markdown with MR list
# Exit codes: 0 = success, 1 = usage error, 3 = API error, 4 = credentials missing

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CREDS_FILE="${SCRIPT_DIR}/.gitlab-credentials"

# Function to show credential setup instructions
show_credential_instructions() {
    cat >&2 <<'EOF'
âŒ GitLab credentials not found or incomplete.

STOP: This script requires GitLab API credentials to be configured.

Please create the file: ~/.claude/scripts/.gitlab-credentials

With the following content:

    # GitLab API Credentials
    GITLAB_PERSONAL_ACCESS_TOKEN="your-token-here"
    GITLAB_API_URL="https://gitlab.com/api/v4"
    GITLAB_PROJECT_ID="your-project-id"

How to get these values:

1. GITLAB_PERSONAL_ACCESS_TOKEN:
   - Go to: https://gitlab.com/-/profile/personal_access_tokens
   - Create token with 'api' scope
   - Copy the token (starts with 'glpat-')

2. GITLAB_PROJECT_ID:
   - Go to your project on GitLab
   - Look under the project name (e.g., "Project ID: 29007973")

3. GITLAB_API_URL:
   - Use "https://gitlab.com/api/v4" for gitlab.com
   - Use your custom URL if self-hosted (e.g., "https://gitlab.yourcompany.com/api/v4")

After creating the file, this script will work automatically.
The credentials file is gitignored and will not be committed.

EOF
    exit 4
}

# Check if credentials file exists
if [ ! -f "$CREDS_FILE" ]; then
    echo "âŒ Credentials file not found: $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

# Source credentials
# shellcheck source=/dev/null
source "$CREDS_FILE"

# Validate required credentials are set
if [ -z "${GITLAB_PERSONAL_ACCESS_TOKEN:-}" ]; then
    echo "âŒ GITLAB_PERSONAL_ACCESS_TOKEN not set in $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

if [ -z "${GITLAB_PROJECT_ID:-}" ]; then
    echo "âŒ GITLAB_PROJECT_ID not set in $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

# Set default API URL if not provided
GITLAB_API_URL="${GITLAB_API_URL:-https://gitlab.com/api/v4}"

# Parse command line arguments
state="opened"
author=""
assignee=""
labels=""

while [[ $# -gt 0 ]]; do
    case $1 in
        --state)
            if [ -z "${2:-}" ]; then
                echo "âŒ --state requires a value (opened|closed|merged|all)" >&2
                exit 1
            fi
            state="$2"
            shift 2
            ;;
        --author)
            if [ -z "${2:-}" ]; then
                echo "âŒ --author requires a username" >&2
                exit 1
            fi
            author="$2"
            shift 2
            ;;
        --assignee)
            if [ -z "${2:-}" ]; then
                echo "âŒ --assignee requires a username" >&2
                exit 1
            fi
            assignee="$2"
            shift 2
            ;;
        --labels)
            if [ -z "${2:-}" ]; then
                echo "âŒ --labels requires comma-separated label list" >&2
                exit 1
            fi
            labels="$2"
            shift 2
            ;;
        -h|--help)
            echo "Usage: gitlab-list-mrs [--state opened|closed|merged|all] [--author <username>] [--assignee <username>] [--labels <label1,label2>]" >&2
            echo "" >&2
            echo "Examples:" >&2
            echo "  gitlab-list-mrs" >&2
            echo "  gitlab-list-mrs --state merged" >&2
            echo "  gitlab-list-mrs --author rmurphy --state opened" >&2
            echo "  gitlab-list-mrs --assignee alice --labels bug,urgent" >&2
            exit 0
            ;;
        *)
            echo "âŒ Unknown option: $1" >&2
            echo "Use --help for usage information" >&2
            exit 1
            ;;
    esac
done

# Validate state value
case "$state" in
    opened|closed|merged|all)
        # Valid state
        ;;
    *)
        echo "âŒ Invalid state: $state (must be: opened, closed, merged, or all)" >&2
        exit 1
        ;;
esac

# Build query parameters
query_params="per_page=100"

if [ "$state" != "all" ]; then
    query_params="${query_params}&state=${state}"
fi

if [ -n "$author" ]; then
    query_params="${query_params}&author_username=${author}"
fi

if [ -n "$assignee" ]; then
    query_params="${query_params}&assignee_username=${assignee}"
fi

if [ -n "$labels" ]; then
    query_params="${query_params}&labels=${labels}"
fi

# Fetch merge requests
mr_response=$(curl -s -H "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
    "${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/merge_requests?${query_params}")

# Check for API errors
if echo "$mr_response" | jq -e '.message' >/dev/null 2>&1; then
    error_msg=$(echo "$mr_response" | jq -r '.message')
    echo "âŒ GitLab API error: $error_msg" >&2
    exit 3
fi

# Count results
mr_count=$(echo "$mr_response" | jq 'length')

if [ "$mr_count" -eq 0 ]; then
    echo "No merge requests found"
    exit 0
fi

# Format output as markdown
echo "ðŸ“‹ Merge Requests ($mr_count found):"
echo ""

echo "$mr_response" | jq -r '.[] |
    "## !\(.iid): \(.title)\n" +
    "**Status:** \(.state)\n" +
    "**Author:** @\(.author.username)\n" +
    "**Assignee:** " + (if .assignee then "@\(.assignee.username)" else "Unassigned" end) + "\n" +
    "**Labels:** " + (if .labels | length > 0 then (.labels | join(", ")) else "None" end) + "\n" +
    "**Created:** \(.created_at | split("T")[0])\n" +
    "**Updated:** \(.updated_at | split("T")[0])\n" +
    "**URL:** \(.web_url)\n" +
    "---\n"
'
