#!/usr/bin/env bash
set -euo pipefail

# gitlab-update-mr - Update merge request metadata
#
# Usage: gitlab-update-mr <mr-iid> [--title <title>] [--description <desc>] [--assignee <username>] [--labels <label1,label2>]
# Example: gitlab-update-mr 1234 --title "Updated title" --labels "bug,urgent"
# Example: gitlab-update-mr 1234 --assignee "jdoe" --description "New description"
#
# Returns: Updated MR details on success
# Exit codes: 0 = success, 1 = usage error, 2 = not found, 3 = API error, 4 = credentials missing

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CREDS_FILE="${SCRIPT_DIR}/.gitlab-credentials"

# Function to show credential setup instructions
show_credential_instructions() {
    cat >&2 <<'EOF'
❌ GitLab credentials not found or incomplete.

STOP: This script requires GitLab API credentials to be configured.

Please create the file: ~/.claude/scripts/.gitlab-credentials

With the following content:

    # GitLab API Credentials
    GITLAB_PERSONAL_ACCESS_TOKEN="your-token-here"
    GITLAB_API_URL="https://gitlab.com/api/v4"
    GITLAB_PROJECT_ID="your-project-id"

How to get these values:

1. GITLAB_PERSONAL_ACCESS_TOKEN:
   - Go to: https://gitlab.com/-/profile/personal_access_tokens
   - Create token with 'api' scope
   - Copy the token (starts with 'glpat-')

2. GITLAB_PROJECT_ID:
   - Go to your project on GitLab
   - Look under the project name (e.g., "Project ID: 29007973")

3. GITLAB_API_URL:
   - Use "https://gitlab.com/api/v4" for gitlab.com
   - Use your custom URL if self-hosted (e.g., "https://gitlab.yourcompany.com/api/v4")

After creating the file, this script will work automatically.
The credentials file is gitignored and will not be committed.

EOF
    exit 4
}

# Check if credentials file exists
if [ ! -f "$CREDS_FILE" ]; then
    echo "❌ Credentials file not found: $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

# Source credentials
# shellcheck source=/dev/null
source "$CREDS_FILE"

# Validate required credentials are set
if [ -z "${GITLAB_PERSONAL_ACCESS_TOKEN:-}" ]; then
    echo "❌ GITLAB_PERSONAL_ACCESS_TOKEN not set in $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

if [ -z "${GITLAB_PROJECT_ID:-}" ]; then
    echo "❌ GITLAB_PROJECT_ID not set in $CREDS_FILE" >&2
    echo "" >&2
    show_credential_instructions
fi

# Set default API URL if not provided
GITLAB_API_URL="${GITLAB_API_URL:-https://gitlab.com/api/v4}"

# Parse arguments
mr_iid="${1:-}"
shift || true

# Validate MR IID provided
if [ -z "$mr_iid" ]; then
    echo "Usage: gitlab-update-mr <mr-iid> [--title <title>] [--description <desc>] [--assignee <username>] [--labels <label1,label2>]" >&2
    echo "Example: gitlab-update-mr 1234 --title \"Updated title\" --labels \"bug,urgent\"" >&2
    exit 1
fi

# Initialize variables for optional parameters
update_title=""
update_description=""
update_assignee=""
update_labels=""
has_updates=false

# Parse optional flags
while [[ $# -gt 0 ]]; do
    case "$1" in
        --title)
            update_title="$2"
            has_updates=true
            shift 2
            ;;
        --description)
            update_description="$2"
            has_updates=true
            shift 2
            ;;
        --assignee)
            update_assignee="$2"
            has_updates=true
            shift 2
            ;;
        --labels)
            update_labels="$2"
            has_updates=true
            shift 2
            ;;
        *)
            echo "❌ Unknown option: $1" >&2
            echo "Usage: gitlab-update-mr <mr-iid> [--title <title>] [--description <desc>] [--assignee <username>] [--labels <label1,label2>]" >&2
            exit 1
            ;;
    esac
done

# Check if at least one update parameter was provided
if [ "$has_updates" = false ]; then
    echo "❌ No update parameters provided" >&2
    echo "Usage: gitlab-update-mr <mr-iid> [--title <title>] [--description <desc>] [--assignee <username>] [--labels <label1,label2>]" >&2
    exit 1
fi

# Build JSON payload dynamically
jq_args=()
jq_filter='{'

if [ -n "$update_title" ]; then
    jq_args+=(--arg title "$update_title")
    jq_filter+='title: $title,'
fi

if [ -n "$update_description" ]; then
    jq_args+=(--arg description "$update_description")
    jq_filter+='description: $description,'
fi

if [ -n "$update_assignee" ]; then
    # Need to get user ID from username first
    user_response=$(curl -s -H "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
        "${GITLAB_API_URL}/users?username=${update_assignee}")

    user_id=$(echo "$user_response" | jq -r '.[0].id // empty')

    if [ -z "$user_id" ]; then
        echo "❌ User not found: ${update_assignee}" >&2
        exit 2
    fi

    jq_args+=(--argjson assignee_id "$user_id")
    jq_filter+='assignee_id: $assignee_id,'
fi

if [ -n "$update_labels" ]; then
    jq_args+=(--arg labels "$update_labels")
    jq_filter+='labels: $labels,'
fi

# Remove trailing comma and close object
jq_filter="${jq_filter%,}}"

# Build JSON payload
json_payload=$(jq -n "${jq_args[@]}" "$jq_filter")

# Update MR via GitLab API
response=$(curl -s -w "\n%{http_code}" \
    -X PUT \
    -H "PRIVATE-TOKEN: $GITLAB_PERSONAL_ACCESS_TOKEN" \
    -H "Content-Type: application/json" \
    -d "$json_payload" \
    "${GITLAB_API_URL}/projects/${GITLAB_PROJECT_ID}/merge_requests/${mr_iid}")

# Split response into body and status code
http_code=$(echo "$response" | tail -1)
body=$(echo "$response" | sed '$d')

# Check HTTP status
if [ "$http_code" = "404" ]; then
    echo "❌ Merge request not found: !${mr_iid}" >&2
    exit 2
elif [ "$http_code" = "401" ]; then
    echo "❌ Authentication failed. Check your GITLAB_PERSONAL_ACCESS_TOKEN" >&2
    exit 3
elif [ "$http_code" = "403" ]; then
    echo "❌ Access denied. You may not have permission to update this merge request." >&2
    exit 3
elif [[ ! "$http_code" =~ ^2[0-9][0-9]$ ]]; then
    echo "❌ GitLab API error (HTTP $http_code)" >&2
    error_msg=$(echo "$body" | jq -r '.message // "Unknown error"')
    echo "Error: $error_msg" >&2
    exit 3
fi

# Parse success response
mr_title=$(echo "$body" | jq -r '.title')
mr_web_url=$(echo "$body" | jq -r '.web_url')
mr_assignee=$(echo "$body" | jq -r '.assignee.username // "Unassigned"')
mr_labels=$(echo "$body" | jq -r '.labels | join(", ") // "None"')

# Output success message
echo "✅ Merge request !${mr_iid} updated successfully!"
echo ""
echo "Title: ${mr_title}"
echo "URL: ${mr_web_url}"
echo "Assignee: ${mr_assignee}"
echo "Labels: ${mr_labels}"
echo ""
echo "Updated fields:"
[ -n "$update_title" ] && echo "  - Title"
[ -n "$update_description" ] && echo "  - Description"
[ -n "$update_assignee" ] && echo "  - Assignee"
[ -n "$update_labels" ] && echo "  - Labels"
