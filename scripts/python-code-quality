#!/usr/bin/env bash
#
# python-code-quality: Python code quality and security scanner
#
# PYTHON ONLY - Do not use for JavaScript, TypeScript, Go, or other languages.
#
# Runs all linters, formatters, type checkers, and security scanners
# on Python code, with clear output and error handling.
#
# Usage:
#   python-code-quality [path]              # Auto-format + check (default)
#   python-code-quality --fix [path]        # Auto-format + fix + check
#   python-code-quality --security [path]   # Security checks only (no format)
#   python-code-quality --no-format [path]  # Check without formatting
#   python-code-quality --help              # Show this help

set -euo pipefail

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Default options
AUTO_FORMAT=true  # Always auto-format by default
AUTO_FIX=false
SECURITY_ONLY=false
TARGET_PATH=""
VENV_PATH="/opt/envs/imports"

# Parse arguments
show_help() {
    cat << EOF
${BOLD}python-code-quality${NC} - Python code quality and security scanner

${RED}PYTHON ONLY${NC} - Do not use for other languages!

${BOLD}Usage:${NC}
    python-code-quality [options] [path]

${BOLD}Options:${NC}
    --no-format     Skip auto-formatting (format is ON by default)
    --fix           Auto-fix issues where possible (includes format)
    --security      Run security checks only (skip style/types/format)
    --help          Show this help message

${BOLD}Examples:${NC}
    python-code-quality fisio/                    # Format + check all
    python-code-quality --fix fisio/imports/      # Format + fix + check
    python-code-quality --security fisio/         # Security scan only
    python-code-quality --no-format fisio/        # Skip formatting

${BOLD}Note:${NC}
    Auto-formatting is ON by default. Use --no-format to skip it.

${BOLD}What it runs:${NC}
    1. Ruff format (always, unless --no-format or --security)
    2. Ruff check (linting, style, basic security)
    3. Pyright (type checking)
    4. Bandit (security vulnerabilities)
    5. Semgrep (injection detection, taint analysis)

${BOLD}Output:${NC}
    All results are shown with clear severity markers:
    ðŸ”´ CRITICAL - Fix immediately (security, data corruption)
    ðŸŸ¡ HIGH     - Fix soon (bugs, type errors, performance)
    ðŸ”µ MEDIUM   - Fix when possible (code smells, complexity)
    ðŸŸ¢ LOW      - Optional (style, minor improvements)

EOF
    exit 0
}

while [[ $# -gt 0 ]]; do
    case $1 in
        --no-format)
            AUTO_FORMAT=false
            shift
            ;;
        --fix)
            AUTO_FIX=true
            AUTO_FORMAT=true  # Fixing always includes formatting
            shift
            ;;
        --security)
            SECURITY_ONLY=true
            AUTO_FORMAT=false  # Security-only skips formatting
            shift
            ;;
        --help|-h)
            show_help
            ;;
        *)
            TARGET_PATH="$1"
            shift
            ;;
    esac
done

# Default to current directory if no path specified
if [[ -z "$TARGET_PATH" ]]; then
    TARGET_PATH="."
fi

# Validate target path exists
if [[ ! -e "$TARGET_PATH" ]]; then
    echo -e "${RED}Error: Path '$TARGET_PATH' does not exist${NC}"
    exit 1
fi

# Activate venv
if [[ -d "$VENV_PATH" ]]; then
    # shellcheck disable=SC1091
    source "$VENV_PATH/bin/activate"
else
    echo -e "${YELLOW}Warning: venv not found at $VENV_PATH${NC}"
    echo -e "${YELLOW}Using system Python instead${NC}"
fi

# Track overall status
ISSUES_FOUND=false
CRITICAL_ISSUES=false

print_header() {
    echo ""
    echo -e "${BOLD}${BLUE}========================================${NC}"
    echo -e "${BOLD}${BLUE}  $1${NC}"
    echo -e "${BOLD}${BLUE}========================================${NC}"
    echo ""
}

print_result() {
    local status=$1
    local message=$2
    if [[ "$status" == "pass" ]]; then
        echo -e "${GREEN}âœ“${NC} $message"
    elif [[ "$status" == "warn" ]]; then
        echo -e "${YELLOW}âš ${NC} $message"
    elif [[ "$status" == "fail" ]]; then
        echo -e "${RED}âœ—${NC} $message"
    fi
}

run_step() {
    local step_name=$1
    local severity=$2  # critical, high, medium, low
    shift 2
    local cmd=("$@")

    echo -e "${BOLD}Running: $step_name${NC}"

    # Run command and capture exit code
    set +e
    output=$("${cmd[@]}" 2>&1)
    exit_code=$?
    set -e

    if [[ $exit_code -eq 0 ]]; then
        print_result "pass" "$step_name passed"
        return 0
    else
        ISSUES_FOUND=true
        if [[ "$severity" == "critical" ]]; then
            CRITICAL_ISSUES=true
            echo -e "${RED}ðŸ”´ CRITICAL${NC} - $step_name found issues"
        elif [[ "$severity" == "high" ]]; then
            echo -e "${YELLOW}ðŸŸ¡ HIGH${NC} - $step_name found issues"
        elif [[ "$severity" == "medium" ]]; then
            echo -e "${BLUE}ðŸ”µ MEDIUM${NC} - $step_name found issues"
        else
            echo -e "${GREEN}ðŸŸ¢ LOW${NC} - $step_name found issues"
        fi

        # Show output
        echo "$output"
        echo ""
        return $exit_code
    fi
}

# Main execution
print_header "Code Quality & Security Analysis"
echo -e "Target: ${BOLD}$TARGET_PATH${NC}"
echo -e "Mode: ${BOLD}$(
    if [[ "$SECURITY_ONLY" == true ]]; then
        echo "Security Only"
    elif [[ "$AUTO_FIX" == true ]]; then
        echo "Auto-Fix"
    elif [[ "$AUTO_FORMAT" == true ]]; then
        echo "Format + Check"
    else
        echo "Check Only"
    fi
)${NC}"
echo ""

# Step 1: Auto-format (if requested)
if [[ "$AUTO_FORMAT" == true ]] && [[ "$SECURITY_ONLY" == false ]]; then
    print_header "Step 1: Auto-Formatting"
    run_step "Ruff format" "low" \
        ruff format "$TARGET_PATH" --config /home/rmurphy/repos/m32rimm/ruff.toml
fi

# Step 2: Ruff linting
if [[ "$SECURITY_ONLY" == false ]]; then
    print_header "Step 2: Ruff Linting"
    if [[ "$AUTO_FIX" == true ]]; then
        run_step "Ruff check (with fixes)" "medium" \
            ruff check "$TARGET_PATH" --fix \
            --config /home/rmurphy/repos/m32rimm/ruff.toml || true
    else
        run_step "Ruff check" "medium" \
            ruff check "$TARGET_PATH" \
            --config /home/rmurphy/repos/m32rimm/ruff.toml || true
    fi
fi

# Step 3: Pyright type checking
if [[ "$SECURITY_ONLY" == false ]]; then
    print_header "Step 3: Type Checking"
    run_step "Pyright" "high" \
        pyright "$TARGET_PATH" || true
fi

# Step 4: Bandit security scan
# -ll: Report LOW+ severity (all severity levels)
# -iii: Report HIGH confidence only (filters false positives)
# WHY -iii: Avoids false positive B608 SQL injection warnings on validated identifiers
print_header "Step 4: Security Scan (Bandit)"
run_step "Bandit" "critical" \
    bandit -r "$TARGET_PATH" \
    -ll -iii \
    -f screen \
    --exclude '*/tests/*,*/test_*,*/.venv/*,*/venv/*' || true

# Step 5: Semgrep security scan
print_header "Step 5: Advanced Security (Semgrep)"
echo -e "${YELLOW}Note: First run may be slow (downloading rules)${NC}"
run_step "Semgrep" "critical" \
    semgrep --config=auto "$TARGET_PATH" \
    --exclude 'tests' \
    --exclude 'test_*' \
    --exclude '.venv' \
    --exclude 'venv' \
    --severity ERROR \
    --severity WARNING || true

# Summary
print_header "Summary"

if [[ "$ISSUES_FOUND" == false ]]; then
    echo -e "${GREEN}${BOLD}âœ“ All checks passed!${NC}"
    echo -e "${GREEN}No issues found in $TARGET_PATH${NC}"
    exit 0
else
    echo -e "${YELLOW}${BOLD}âš  Issues found${NC}"

    if [[ "$CRITICAL_ISSUES" == true ]]; then
        echo -e "${RED}${BOLD}ðŸ”´ CRITICAL security issues found!${NC}"
        echo -e "${RED}Please review and fix before committing.${NC}"
        exit 1
    else
        echo -e "${BLUE}Non-critical issues found.${NC}"
        echo -e "${BLUE}Consider fixing before committing.${NC}"
        exit 0
    fi
fi
